<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade! Hooray!</title>
    <style>
        
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; background: #111; color: white; touch-action: none; }
        :root{
            --ui-bg: rgba(255,255,255,0.07);
            --ui-bg2: rgba(0,0,0,0.32);
            --ui-border: rgba(255,255,255,0.16);
            --ui-border-strong: rgba(255,255,255,0.28);
            --ui-accent: #00e5ff;
            --ui-radius: 14px;
        }
        .ui-btn{
            display:inline-flex; align-items:center; justify-content:center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--ui-radius);
            border: 1px solid var(--ui-border);
            background: var(--ui-bg);
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.2px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .ui-btn:active{ transform: scale(0.98); border-color: var(--ui-border-strong); }

        
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1a1a1a, #000); z-index: 999;
            transition: opacity 0.3s;
        }
        
        .menu-title { font-size: 2.2rem; margin-bottom: 16px; color: #ffd700; text-shadow: 0 0 12px rgba(255,215,0,0.25); font-weight: 900; letter-spacing: 2px; text-align: center; line-height: 1; }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 12px; 
            padding: 12px; 
            max-width: 920px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .game-card {
            width: 100%; height: 86px;
            background: #333; border: 2px solid #555; border-radius: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.35);
        }
        .game-card:hover { transform: translateY(-5px); border-color: #fff; background: #444; }
        .game-card h2 { margin: 0; font-size: 1.2rem; pointer-events: none; }
        .game-card span { font-size: 0.72rem; color: #aaa; margin-top: 3px; pointer-events: none; text-align:center; }

        .game-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; z-index: 100;
        }
        .game-view.active { display: flex; }

        .back-btn{position:fixed;top:calc(env(safe-area-inset-top, 0px) + 10px);left:calc(env(safe-area-inset-left, 0px) + 10px);z-index:1000;background:rgba(0,0,0,0.55);color:#fff;border:1px solid var(--ui-border);padding:9px 12px;border-radius:var(--ui-radius);cursor:pointer;font-size:14px;backdrop-filter:blur(6px);font-weight:900;letter-spacing:0.2px;}
        .back-btn:hover{background:rgba(255,255,255,0.10);border-color:var(--ui-border-strong);}

        
        
        
        #global-settings-btn{
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 10px);
            right: calc(env(safe-area-inset-right, 0px) + 10px);
            z-index: 1300;
            padding: 8px 10px;
            min-width: 44px;
        }
        body.swap-corners #global-settings-btn{ right: auto; left: 10px; }
        body.swap-corners .back-btn{ left: auto !important; right: 10px !important; }

        #global-settings-modal{
            position: fixed; inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.65);
            backdrop-filter: blur(6px);
            z-index: 2000;
        }
        #global-settings-modal .settings-panel{
            width: min(520px, calc(100vw - 28px));
            background: rgba(20,20,20,0.92);
            border: 1px solid var(--ui-border-strong);
            border-radius: 18px;
            box-shadow: 0 18px 48px rgba(0,0,0,0.55);
            padding: 14px 14px 12px 14px;
        }
        #global-settings-modal .settings-head{
            display:flex; align-items:center; justify-content:space-between;
            gap: 12px;
            margin-bottom: 10px;
        }
        #global-settings-modal .settings-title{
            font-weight: 900;
            letter-spacing: 0.6px;
            font-size: 1.15rem;
            color: #ffd700;
            text-shadow: 0 0 12px rgba(255,215,0,0.18);
        }
        #global-settings-modal .settings-close{
            padding: 6px 10px;
            min-width: 44px;
        }
        #global-settings-modal .settings-row{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
            padding: 10px 10px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.05);
            margin: 8px 0;
        }
        #global-settings-modal .settings-row .label{
            display:flex; flex-direction:column; gap: 3px;
        }
        #global-settings-modal .settings-row .label .name{
            font-weight: 900;
        }
        #global-settings-modal .settings-row .label .desc{
            font-size: 12px;
            color: rgba(255,255,255,0.72);
        }
        #global-settings-modal input[type="checkbox"]{
            width: 20px; height: 20px;
            accent-color: var(--ui-accent);
        }
        #global-settings-modal .settings-actions{
            display:flex; gap: 10px; justify-content:flex-end; align-items:center;
            margin-top: 10px;
        }

        
        body.reduce-motion *, body.reduce-motion *::before, body.reduce-motion *::after{
            animation: none !important;
            transition: none !important;
        }
        body.high-contrast{
            background: #000;
            --ui-bg: rgba(255,255,255,0.14);
            --ui-bg2: rgba(0,0,0,0.62);
            --ui-border: rgba(255,255,255,0.34);
            --ui-border-strong: rgba(255,255,255,0.62);
        }
        body.high-contrast .game-card{
            background: #111;
            border-color: rgba(255,255,255,0.75);
        }
        body.high-contrast .game-card:hover{
            background: #1a1a1a;
            border-color: #fff;
        }
.overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.95); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .splash-title { font-size: 3rem; color: #fff; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,255,255,0.3); text-align: center; }
        .btn-large-opt {
            background: #333; border: 2px solid #555; color: #fff;
            padding: 20px; font-size: 1.5rem; border-radius: 15px; width: 80%; max-width: 300px;
            cursor: pointer; transition: transform 0.1s; text-align: center;
        }
        .btn-large-opt:active { transform: scale(0.98); background: #444; }

        
        #feedback-overlay {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%;
            z-index: 2000; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); pointer-events: none;
        }
        #feedback-content { font-size: 15vw; font-weight: 900; text-shadow: 0 0 30px rgba(255,255,255,0.8); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width:100%; text-align: center; }
        .fb-win { color: #2ecc71; }
        .fb-loss { color: #e74c3c; animation: shake 0.5s ease-in-out !important; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-20px) rotate(-5deg);} 75% {transform: translateX(20px) rotate(5deg);} }

        
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; max-width: 250px; }
        .kp-btn { 
            background: #444; border: 1px solid #666; color: #fff; 
            padding: 15px; font-size: 20px; border-radius: 8px; cursor: pointer; user-select: none;
        }
        .kp-btn:active { background: #666; }
        .kp-act { background: #2980b9; border-color: #3498db; }
        .kp-del { background: #c0392b; border-color: #e74c3c; }
        .kp-ok { background: #27ae60; border-color: #2ecc71; grid-column: span 3; }

        
        #g-blackjack {
            --felt-color: #277714; --felt-dark: #1b520e;
            --card-w: 75px; --card-h: 108px; --chip-size: 55px;
            background-color: #111; flex-direction: column;
        }
        #g-blackjack .modal-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 20px; text-align: center;
        }
        #g-blackjack .btn-large {
            padding: 20px 30px; font-size: 20px; background: linear-gradient(145deg, #d4af37, #b49020);
            border: 2px solid #fff; border-radius: 12px; cursor: pointer; font-weight: bold; color: #111; min-width: 140px;
        }
        #g-blackjack #table {
            flex: 1; background: radial-gradient(circle at center, var(--felt-color) 0%, var(--felt-dark) 90%);
            display: flex; flex-direction: column; position: relative; width: 100%;
        }
        #g-blackjack #status-banner {
            background: rgba(0,0,0,0.7); color: #d4af37; text-align: center; padding: 10px;
            font-size: 18px; font-weight: bold; border-bottom: 1px solid #d4af37;
            text-transform: uppercase; letter-spacing: 1px; padding-left: 90px;
            display: flex; justify-content: center; align-items: center; gap: 20px; min-height: 44px;
        }
        #g-blackjack #dealer-area {
            flex: 0 0 180px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        #g-blackjack .dealer-rule-text { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-top: 2px; }
        #g-blackjack #players-area {
            flex: 1; display: flex; justify-content: center; align-items: flex-start;
            gap: 5px; padding: 10px; overflow-x: auto; width: 100%; box-sizing: border-box;
        }
        #g-blackjack .player-seat {
            display: flex; flex-direction: column; align-items: center;
            min-width: 95px; flex: 1; max-width: 200px;
            opacity: 1; transition: opacity 0.3s; position: relative;
        }
        #g-blackjack .player-seat.inactive { opacity: 0.5; }
        #g-blackjack .player-seat.bankrupt { opacity: 0.3; filter: grayscale(100%); }
        #g-blackjack .player-info {
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 6px;
            text-align: center; width: 90%; margin-bottom: 5px; border: 1px solid #555; z-index: 20;
            display: flex; flex-direction: column; gap: 2px;
        }
        #g-blackjack .player-seat.active .player-info { border-color: #d4af37; box-shadow: 0 0 10px #d4af37; }
        #g-blackjack .p-name { font-size: 12px; font-weight: bold; color: #aaa; }
        #g-blackjack .p-bank { font-size: 13px; color: #4f4; font-family: monospace; }
        #g-blackjack .p-bet { font-size: 14px; color: #ffd700; font-family: monospace; font-weight: bold; border-top: 1px solid #444; margin-top: 2px; padding-top: 2px; }
        
        #g-blackjack .visual-chips {
            height: 40px; width: 100%; display: flex; flex-direction: column-reverse; 
            align-items: center; position: relative; top: -10px;
        }
        #g-blackjack .v-chip {
            width: 40px; height: 10px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.5);
            margin-top: -6px; box-shadow: 0 2px 4px #000;
        }
        
        #g-blackjack .hands-wrapper { display: flex; justify-content: center; width: 100%; gap: 10px; }
        #g-blackjack .hand-container { position: relative; height: 200px; width: 90px; margin-top: 10px; transition: opacity 0.3s; }
        #g-blackjack .card {
            width: var(--card-w); height: var(--card-h);
            background: #fff; border-radius: 6px; position: absolute;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 4px; box-sizing: border-box; font-weight: bold; font-size: 18px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); top: 0; left: 0;
        }
        #g-blackjack .card.red { color: #d00; } 
        #g-blackjack .card.black { color: #000; }
        #g-blackjack .rank-suit { line-height: 0.9; display: flex; flex-direction: column; align-items: center; }
        #g-blackjack .big-suit { position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); font-size: 36px; opacity: 0.2; }
        #g-blackjack .bottom-right { transform: rotate(180deg); position: absolute; bottom: 4px; right: 4px; }
        #g-blackjack .card-back { background: repeating-linear-gradient(45deg, #900, #900 5px, #a00 5px, #a00 10px); border: 2px solid #fff; }
        #g-blackjack .card-back * { display: none; }
        #g-blackjack .bubble {
            border-radius: 20px; position: absolute; z-index: 50;
            box-shadow: 0 3px 6px rgba(0,0,0,0.8); font-weight: bold;
            display: flex; justify-content: center; align-items: center;
        }
        #g-blackjack .score-bubble { 
            top: -15px; right: -10px; background: #d4af37; color: #000;
            font-size: 18px; min-width: 32px; height: 32px; border: 2px solid #fff;
        }
        #g-blackjack .result-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 20px; font-weight: 900; text-shadow: 0 0 10px #000; z-index: 60;
            background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 8px; border: 2px solid white;
            animation: popIn 0.3s forwards; pointer-events: none; white-space: nowrap;
        }
        #g-blackjack .win { color: #4f4; border-color: #4f4; }
        #g-blackjack .lose { color: #f44; border-color: #f44; }
        #g-blackjack .push { color: #ff0; border-color: #ff0; }
        #g-blackjack .bj { color: #ffd700; border-color: #ffd700; }
        #g-blackjack .charlie { color: #00e5ff; border-color: #00e5ff; }
        
        #g-blackjack #controls-bar {
            background: #000; border-top: 2px solid #333; padding: 10px;
            min-height: 90px; display: flex; align-items: center; justify-content: center; width: 100%; box-sizing: border-box;
        }
        #g-blackjack .control-group { display: none; gap: 10px; width: 100%; justify-content: center; }
        #g-blackjack .control-group.active { display: flex; }
        #g-blackjack .chip {
            width: var(--chip-size); height: var(--chip-size);
            border-radius: 50%; border: 4px dashed rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; color: #fff; font-size: 16px;
            box-shadow: 0 4px 8px #000;
        }
        #g-blackjack .c10 { background: #007bff; } 
        #g-blackjack .c50 { background: #28a745; } 
        #g-blackjack .c100 { background: #111; color: #ffd700; border-color: #ffd700; }
        #g-blackjack .btn-action {
            padding: 15px 0; flex: 1; max-width: 100px;
            border-radius: 8px; border: none; font-weight: bold; font-size: 14px;
            color: #fff; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }
        #g-blackjack .hit { background: #28a745; } 
        #g-blackjack .stand { background: #dc3545; }
        #g-blackjack .double { background: #ffc107; color: #000; } 
        #g-blackjack .split { background: #6f42c1; }
        #g-blackjack .deal { background: #ffd700; color: #000; max-width: 200px; font-size: 22px; }
        #g-blackjack .clear { background: #555; max-width: 60px; font-size: 11px; padding: 10px 0; }
        #g-blackjack .max { background: #ff5722; max-width: 60px; font-size: 11px; padding: 10px 0; }
        #g-blackjack .streak-pill { background: #222; border: 1px solid #ffd700; color: #ffd700; padding: 5px 10px; border-radius: 15px; font-size: 12px; }

        
        #g-hangman { background:#1e1e1e; flex-direction:column; transition: background 0.3s; }
        #g-hangman.risk-bg { background: #4a0000; }
        
        @keyframes keyShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .key-shaking { animation: keyShake 0.3s ease-in-out; background: #a71d2a !important; }

        #g-hangman .top-bar { 
            padding:5px 10px;
            display:grid;
            grid-template-columns: 90px 1fr auto;
            align-items:center;
            background:#2c2c2c;
            border-bottom:1px solid #444;
            min-height: 55px;
            width: 100%;
            box-sizing: border-box;
            gap: 8px;
        }
        #g-hangman .hm-left-slot{ width:90px; height: 1px; }
        #g-hangman .top-bar .cat-pill{ justify-self: center; cursor: pointer; }
        #g-hangman .hm-status{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; justify-self:end; min-width: 0; }
        #g-hangman .heart-container{ white-space: nowrap; line-height: 1; font-size: clamp(14px, 4.2vw, 18px); letter-spacing: 1px; max-width: 48vw; overflow: hidden; }
        #g-hangman .cat-pill {
            background: #333; color: #ffc107; padding: 6px 14px; border-radius: 20px;
            font-weight: bold; font-size: 14px; border: 1px solid #555; text-transform: uppercase;
        }
        #g-hangman .game-area { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; gap: 5px; width: 100%; }
        #g-hangman canvas { background:transparent; max-height: 22vh; width: 100%; object-fit:contain; }
        #g-hangman #hm-confetti-canvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:40; }
        #g-hangman #word-display { 
            font-size: 42px; letter-spacing: 4px; margin: 5px 0; 
            font-family: monospace; font-weight:bold; color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); min-height: 50px; text-align: center;
            width: 100%; white-space: nowrap;
        }
        #g-hangman #hint-box {
            background: #333; color: #ffc107; 
            padding: 8px 15px; border-radius: 8px; border: 1px solid #555;
            font-size: 18px; text-align: center; font-style: italic;
            width: 85%; visibility: hidden;
            min-height: 24px; display:flex; align-items:center; justify-content:center;
        }
        #g-hangman .controls { width:100%; display:flex; justify-content:center; gap: 15px; padding-bottom:5px; margin-top:5px; }
        #g-hangman .keyboard { 
            display:grid;
            grid-template-columns: repeat(7, 1fr);
            gap:6px;
            padding:6px;
            width: min(600px, calc(100vw - 20px));
            margin: 0 auto 6px auto;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        #g-hangman .keyboard.risk-active { background: rgba(255, 165, 0, 0.15); border-radius: 12px; box-shadow: 0 0 15px rgba(255, 165, 0, 0.3); }
        #g-hangman .key {
            width: auto; height: 54px; 
            background: #3a3a3a; border-bottom: 4px solid #222; color: #fff;
            border-radius: 8px; font-weight:bold; font-size:22px;
            display:flex; justify-content:center; align-items:center;
            cursor:pointer; transition: transform 0.1s, background 0.2s;
        }
        #g-hangman .key:active { transform: translateY(2px); border-bottom-width: 2px; }
        #g-hangman .key.correct { background: #28a745; border-color: #1e7e34; opacity: 0.3; pointer-events:none; }
        #g-hangman .key.wrong { background: #dc3545; border-color: #a71d2a; opacity: 0.3; pointer-events:none; }
        #g-hangman button { border:none; border-radius: 8px; font-weight:bold; cursor:pointer; font-size:16px; transition: opacity 0.2s; }
        #g-hangman .btn-blue { background:#007bff; color:white; padding: 6px 12px; font-size:14px; }
        #g-hangman .btn-hint { background:#444; color:#ddd; padding: 10px 20px; display:flex; align-items:center; gap:6px; font-size:16px; border:1px solid #666; }
        #g-hangman .btn-risk { 
            background: linear-gradient(135deg, #ffc107, #ff8c00); 
            color:#000; padding: 10px 20px; 
            display:flex; align-items:center; gap:6px; font-size:16px;
            box-shadow: 0 4px 0 #b8860b; transition: transform 0.1s;
        }
        #g-hangman .btn-risk:active { transform: translateY(2px); box-shadow: 0 2px 0 #b8860b; }
        #g-hangman .overlay { 
            position:absolute; top:0; left:0; right:0; bottom:0; 
            background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index:50;
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; 
        }
        #g-hangman .cat-grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; width: 85%; max-width:400px; }
        #g-hangman .cat-btn { padding:20px; font-size:18px; background:#444; color:#fff; border-radius:12px; }
        #g-hangman .btn-green { background:#28a745; color:white; padding: 15px 40px; font-size: 22px; box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4); }
        #g-hangman .input-group { display:flex; flex-direction:column; gap:10px; width:80%; max-width:300px; }
        #g-hangman .custom-field { 
            font-size:20px; padding:12px; text-transform:uppercase; 
            text-align:center; width: 100%; box-sizing:border-box;
            background: #333; color:#fff; border: 2px solid #555; border-radius:8px;
        }
        #hm-streak { font-size:14px; color:#ff9900; font-weight:bold; margin-right:10px; }

        
        #g-dots { background:#000; flex-direction: column; }
        #g-dots .wrap {
            height: 100%; width: 100%;
            display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; gap: 10px;
        }
        #g-dots .top {
            flex: 0 0 auto; background: #222; border: 1px solid #444;
            border-radius: 12px; padding: 10px; padding-left: 90px;
            display: flex; flex-direction: column; gap: 8px; z-index: 10;
        }
        #g-dots .row { display: flex; align-items: center; justify-content: space-between; }
        #g-dots button {
            background: #444; border: 1px solid #666; color: #fff;
            font-size: 13px; font-weight: 600; padding: 8px 12px;
            border-radius: 6px; cursor: pointer;
        }
        #g-dots .pill {
            background: #333; border: 1px solid #555; padding: 6px 12px;
            border-radius: 99px; font-size: 14px; white-space: nowrap;
            display: flex; align-items: center;
        }
        #g-dots .status-pill { flex: 1; margin-left: 8px; justify-content: center; overflow: hidden; }
        #g-dots #turnDot {
            width: 14px; height: 14px; border-radius: 50%; background: #444; 
            margin-right: 10px; transition: all 0.2s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        #g-dots .boardBox {
            flex: 1; background: #111; border: 1px solid #333; border-radius: 12px;
            position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        #g-dots .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92); display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; border-radius: 12px; gap: 20px;
        }
        #g-dots .grid-options { display: flex; flex-direction: column; gap: 10px; width: 220px; }
        #g-dots .grid-btn { padding: 14px; font-size: 16px; background: #222; border: 1px solid #555; color: #ddd; }

        #g-dots .dots-mode-row, #g-dots .dots-ai-row { display:flex; gap:10px; width: 240px; justify-content:center; }
        #g-dots .dots-mode-btn { flex: 1; font-size: 14px; padding: 12px; }
        #g-dots .dots-ai-btn { flex: 1; font-size: 14px; padding: 10px; }
        #g-dots .dots-sel { border-color:#ffd700 !important; color:#ffd700 !important; box-shadow: 0 0 0 2px rgba(255,215,0,0.35) inset; }
        #g-dots canvas { display: block; touch-action: none; border-radius: 8px; }
        #g-dots #dots-confetti-canvas { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 25; }
        
        @keyframes popUpFade { 0% { opacity:0; transform:scale(0.5); } 20% { opacity:1; transform:scale(1.2); } 100% { opacity:0; transform:scale(1); } }
        #combo-text { position:absolute; font-size:3rem; font-weight:900; color:#ffd700; text-shadow:0 0 10px #000; pointer-events:none; opacity:0; }
        .combo-anim { animation: popUpFade 1s forwards; }

        
        #g-balloons { position: relative; width: 100%; height: 100%; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); overflow: hidden; transition: background 1s; }
        body.rainbow-active #g-balloons { background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb, #8fd3f4); background-size: 400% 400%; animation: rb-bg 3s ease infinite; }
        @keyframes rb-bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #g-balloons canvas { display: block; width: 100%; height: 100%; }
        
        #g-balloons .b-ui { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        #g-balloons .b-header { display: flex; justify-content: flex-end; width: 100%; margin-top: 40px; }
        #g-balloons .b-counters { display: flex; gap: 10px; }
        #g-balloons .b-pill { background: rgba(255,255,255,0.9); color: #333; padding: 8px 18px; border-radius: 50px; font-size: 1.4rem; font-weight: 900; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; }
        #g-balloons .b-meter-wrap { width: 100%; max-width: 300px; height: 18px; background: rgba(0,0,0,0.3); border: 2px solid white; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #g-balloons .b-fill { height: 100%; width: 0%; background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); transition: width 0.3s; }
        #g-balloons .b-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px #FF00FF, 0 0 40px #00FFFF; display: none; pointer-events: none; z-index: 50; animation: bPop 0.5s forwards; }
        @keyframes bPop { 0% { transform: translate(-50%, -50%) scale(0); } 70% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }

#g-balloons .b-milestone { 
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-size: min(18vw, 6.2rem);
    font-weight: 1000;
    text-align:center;
    line-height: 0.95;
    color:#fff;
    text-shadow: 0 0 18px rgba(0,0,0,0.55), 0 0 30px #FF00FF, 0 0 40px #00FFFF;
    display:none;
    pointer-events:none;
    z-index: 55;
}
#g-balloons .b-milestone.show { display:block; animation: bMilestone 1.2s forwards; }
@keyframes bMilestone {
    0% { opacity:0; transform: translate(-50%, -50%) scale(0.25) rotate(-10deg); }
    18% { opacity:1; transform: translate(-50%, -50%) scale(1.25) rotate(10deg); }
    55% { opacity:1; transform: translate(-50%, -50%) scale(1.05) rotate(-4deg); }
    100% { opacity:0; transform: translate(-50%, -50%) scale(1.25) rotate(0deg); }
}

body.unicorn-mega #g-balloons { animation: megaHue 0.7s linear infinite; }
@keyframes megaHue { 0%{ filter:hue-rotate(0deg) saturate(1.6); } 50%{ filter:hue-rotate(180deg) saturate(2.2); } 100%{ filter:hue-rotate(360deg) saturate(1.6);} }
body.unicorn-mega #g-balloons canvas { animation: megaShake 0.12s infinite; }
@keyframes megaShake { 0%{ transform: translate(0,0); } 25%{ transform: translate(2px,-2px); } 50%{ transform: translate(-2px,2px); } 75%{ transform: translate(2px,2px); } 100%{ transform: translate(-2px,-2px); } }
body.reduce-motion.unicorn-mega #g-balloons, body.reduce-motion.unicorn-mega #g-balloons canvas { animation:none !important; filter:none !important; }
        #g-balloons .b-start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 60; }
        #g-balloons .big-play-btn { font-size: 2rem; padding: 20px 60px; background: linear-gradient(to bottom, #E040FB, #7C4DFF); color: white; border: 4px solid white; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4); animation: pulse 1.5s infinite; margin-top: 20px; }

        
        #g-minesweeper { background: #222; flex-direction: column; user-select: none; }
        #g-minesweeper .ms-top {
            flex: 0 0 60px; background: #333; width: 100%; border-bottom: 2px solid #555;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            padding-left: 90px;
        }
        #g-minesweeper .ms-counter {
            background: #000; color: #f00; font-family: 'Courier New', monospace; font-size: 24px;
            font-weight: bold; padding: 4px 8px; border: 2px solid #555; border-radius: 4px; width: 60px; text-align: center;
        }
        #g-minesweeper .ms-face {
            font-size: 32px; background: #444; border: 2px solid #666; border-radius: 50%;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }
        #g-minesweeper .ms-face:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        
        #g-minesweeper .ms-board-wrap {
            flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; width: 100%; padding: 10px; box-sizing: border-box; position: relative;
        }
        #g-minesweeper .ms-grid {
            display: grid; gap: 1px; background: #555; padding: 4px; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #g-minesweeper .ms-cell {
            background: #888; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; font-weight: 900; 
            font-size: 100%;
            overflow: hidden;
            line-height: 1;
            cursor: pointer; position: relative;
        }
        #g-minesweeper .ms-cell.covered {
            background: linear-gradient(135deg, #aaa, #888);
            box-shadow: inset 2px 2px 0 rgba(255,255,255,0.4), inset -2px -2px 0 rgba(0,0,0,0.2);
        }
        #g-minesweeper .ms-cell.covered:hover { background: #bbb; }
        #g-minesweeper .ms-cell.revealed { background: #bbb; border: 1px solid #999; }
        #g-minesweeper .ms-cell.mine { background: #f44; border: 1px solid #d00; }
        
        #g-minesweeper .c1 { color: #00f; }
        #g-minesweeper .c2 { color: #008000; }
        #g-minesweeper .c3 { color: #f00; }
        #g-minesweeper .c4 { color: #000080; }
        #g-minesweeper .c5 { color: #800000; }
        #g-minesweeper .c6 { color: #008080; }
        #g-minesweeper .c7 { color: #000; }
        #g-minesweeper .c8 { color: #808080; }

        #g-minesweeper .btn-opt {
            background: #444; color: #fff; padding: 15px 30px; border: 1px solid #666;
            font-size: 18px; width: 220px; border-radius: 8px; cursor: pointer; text-align: center;
        }
        #g-minesweeper .btn-opt:hover { background: #555; border-color: #fff; }

        
        #g-clock { background: #2c3e50; flex-direction: column; align-items: center; justify-content: center; }
        #g-clock .clock-face { 
            background: #fff; border-radius: 50%; border: 10px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); margin-bottom: 20px;
        }
        #g-clock .clock-ui { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        #g-clock .display-box {
            font-size: 30px; font-weight: bold; background: #fff; color: #000;
            padding: 10px 20px; border-radius: 8px; min-width: 120px; text-align: center;
        }
        #g-clock .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-width: 400px; }
        #g-clock .mc-btn { 
            background: #34495e; color: #ecf0f1; padding: 15px; border-radius: 8px; 
            border: 2px solid #2c3e50; font-size: 24px; cursor: pointer;
        }
        #g-clock .mc-btn:active { background: #2c3e50; }
        
        
        #g-math { background: #8e44ad; flex-direction: column; align-items: center; justify-content: center; }
        #g-math .math-box {
            background: rgba(255,255,255,0.1); border-radius: 20px; padding: 15px;
            width: 95%; max-width: 500px; display: flex; flex-direction: column; align-items: center;
            border: 2px solid rgba(255,255,255,0.2); text-align: center;
            height: 90vh; justify-content: center;
        }
        #g-math .problem { font-size: 3rem; font-weight: bold; margin: 10px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        #g-math .word-problem { font-size: 1.5rem; margin: 10px 0; line-height: 1.4; padding: 0 10px; }
        #g-math .math-display {
            font-size: 2.5rem; padding: 10px; width: 180px; text-align: center;
            background: rgba(0,0,0,0.3); color: #fff;
            border-radius: 10px; border: 2px solid rgba(255,255,255,0.3); margin-bottom: 10px;
            min-height: 60px; display: flex; align-items: center; justify-content: center;
        }

        
        #g-tictactoe { background: radial-gradient(circle at center, #1a1a1a 0%, #000 80%); flex-direction: column; }
        #g-tictactoe .ttt-top {
            height: 60px; width: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); border-bottom: 1px solid rgba(255,255,255,0.15);
            box-sizing: border-box; padding-left: 90px;
            gap: 12px;
        }
        #g-tictactoe .ttt-pill {
            background: #222; border: 1px solid #444; color: #fff;
            padding: 6px 12px; border-radius: 999px; font-weight: 800; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 10px;
        }
        #g-tictactoe .ttt-score { font-family: monospace; color: #ffd700; }
        #g-tictactoe .ttt-wrap { flex: 1; display:flex; align-items:center; justify-content:center; padding: 20px; box-sizing: border-box; }
        #g-tictactoe .ttt-board {
            width: min(88vw, 420px); height: min(88vw, 420px);
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            gap: 10px; padding: 12px;
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.12);
            border-radius: 18px; box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        #g-tictactoe .ttt-cell {
            background: linear-gradient(145deg, #2a2a2a, #111);
            border: 2px solid rgba(255,255,255,0.12);
            border-bottom-width: 6px;
            border-radius: 14px;
            display:flex; align-items:center; justify-content:center;
            font-weight: 900; font-size: clamp(40px, 9vw, 90px);
            cursor: pointer; user-select: none;
            transition: transform 0.08s, border-color 0.2s, background 0.2s;
        }
        #g-tictactoe .ttt-cell:active { transform: scale(0.98); }
        #g-tictactoe .ttt-x { color: #ff5252; text-shadow: 0 0 14px rgba(255,82,82,0.35); }
        #g-tictactoe .ttt-o { color: #00e5ff; text-shadow: 0 0 14px rgba(0,229,255,0.35); }
        #g-tictactoe .ttt-win {
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255,215,0,0.35);
            background: linear-gradient(145deg, #3a3200, #1a1400) !important;
        }
        #g-tictactoe .ttt-mini {
            display: flex; gap: 10px; margin-top: 12px; justify-content: center;
        }
        #g-tictactoe .ttt-btn {
            background: #333; border: 1px solid #666; color: #fff;
            padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 800;
        }
        #g-tictactoe .ttt-btn:active { transform: scale(0.98); }
        #g-tictactoe .ttt-sub { color: #aaa; font-size: 14px; text-align: center; max-width: 420px; }

        
        #g-maze { background: radial-gradient(circle at 30% 20%, #0b1a2b 0%, #000 70%); flex-direction: column; }
        #g-maze .mz-top {
            height: 60px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.7); border-bottom: 1px solid rgba(255,255,255,0.15);
            box-sizing: border-box; padding: 0 12px; padding-left: 90px;
            gap: 10px;
        }
        #g-maze .mz-left, #g-maze .mz-right { display:flex; align-items:center; gap: 10px; }
        #g-maze .mz-pill {
            background: #122034; border: 1px solid rgba(255,255,255,0.18);
            padding: 6px 12px; border-radius: 999px; font-weight: 900; letter-spacing: 0.5px;
            display:flex; align-items:center; gap: 8px;
        }
        #g-maze .mz-pill span { font-family: monospace; color: #ffd700; }
        #g-maze .mz-btn {
            background: #1b2e4b; border: 1px solid rgba(255,255,255,0.22);
            color: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 800;
        }
        #g-maze .mz-btn:active { transform: scale(0.98); }
        #g-maze .mz-wrap {
            flex: 1; display:flex; flex-direction: column;
            align-items:center; justify-content: center; gap: 10px;
            padding: 10px; box-sizing: border-box;
        }
        #g-maze .mz-canvas-wrap {
            flex: 1; width: 100%; max-width: 740px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--ui-border);
            border-radius: var(--ui-radius);
            display:flex; align-items:center; justify-content:center;
            position: relative;
            overflow: hidden;
        }
        #g-maze canvas { width: 100%; height: 100%; display:block; touch-action: none; }
        #g-maze .mz-pad {
            flex: 0 0 auto;
            width: min(360px, 92vw);
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-bottom: 8px;
        }
        #g-maze .mz-pad .mz-pad-btn {
            background: rgba(0,0,0,0.55); border: 2px solid rgba(255,255,255,0.18);
            color: #fff; border-radius: var(--ui-radius);
            font-size: 24px; font-weight: 900;
            height: 62px; cursor:pointer; user-select:none;
            display:flex; align-items:center; justify-content:center;
        }
        #g-maze .mz-pad .mz-pad-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.12); }
        #g-maze .mz-pad .blank { opacity: 0; pointer-events:none; }
        #g-maze .mz-hint {
            color: rgba(255,255,255,0.7);
            font-size: 13px; text-align: center;
            margin-top: -4px;
        }

        
        #g-checkers { background: radial-gradient(circle at center, #1b0b0b 0%, #000 75%); flex-direction: column; }
        #g-checkers .ck-top {
            height: 60px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.7); border-bottom: 1px solid rgba(255,255,255,0.15);
            box-sizing: border-box; padding: 0 12px; padding-left: 90px;
        }
        #g-checkers .ck-pill {
            background: #2a1111; border: 1px solid rgba(255,255,255,0.18);
            padding: 6px 12px; border-radius: 999px; font-weight: 900; letter-spacing: 0.5px;
            display:flex; align-items:center; gap: 10px;
        }
        #g-checkers .ck-pill .ck-turn { color: #ffd700; font-family: monospace; }
        #g-checkers .ck-btn {
            background: #3a1616; border: 1px solid rgba(255,255,255,0.22);
            color: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 800;
        }
        #g-checkers .ck-btn:active { transform: scale(0.98); }
        #g-checkers .ck-wrap {
            flex: 1; display:flex; flex-direction: column; align-items:center; justify-content:center;
            padding: 12px; box-sizing:border-box; gap: 10px;
        }
        #g-checkers .ck-board-wrap {
            width: min(92vw, 560px);
            aspect-ratio: 1 / 1;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--ui-border);
            border-radius: var(--ui-radius);
            overflow: hidden;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        #g-checkers canvas { width: 100%; height: 100%; display:block; touch-action: none; }
        #g-checkers .ck-sub {
            color: rgba(255,255,255,0.75);
            font-size: 13px; text-align:center;
            max-width: 560px;
        }

        
        #g-simon { background: radial-gradient(circle at center, #0a0a0a 0%, #000 80%); flex-direction: column; }
        #g-simon .si-top {
            height: 60px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.7); border-bottom: 1px solid rgba(255,255,255,0.15);
            box-sizing: border-box; padding: 0 12px; padding-left: 90px;
        }
        #g-simon .si-pill {
            background: #1a1a1a; border: 1px solid rgba(255,255,255,0.18);
            padding: 6px 12px; border-radius: 999px; font-weight: 900; letter-spacing: 0.5px;
            display:flex; align-items:center; gap: 10px;
        }
        #g-simon .si-pill span { color: #ffd700; font-family: monospace; }
        #g-simon .si-btn {
            background: #222; border: 1px solid rgba(255,255,255,0.22);
            color: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 800;
        }
        #g-simon .si-btn:active { transform: scale(0.98); }
        #g-simon .si-wrap {
            flex: 1; display:flex; flex-direction: column;
            align-items:center; justify-content:center; padding: 18px; gap: 14px;
        }
        #g-simon .si-board {
            width: min(84vw, 460px); aspect-ratio: 1 / 1;
            display:grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
            gap: 14px; padding: 14px;
            border-radius: 22px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--ui-border);
            box-shadow: 0 0 25px rgba(0,0,0,0.7);
        }
        #g-simon .si-pad {
            border-radius: 18px;
            border: 2px solid rgba(255,255,255,0.12);
            cursor: pointer;
            user-select:none;
            display:flex; align-items:center; justify-content:center;
            font-weight: 900; letter-spacing: 1px;
            font-size: 18px;
            text-shadow: 0 0 12px rgba(0,0,0,0.6);
            transition: transform 0.08s, filter 0.1s, box-shadow 0.1s;
        }
        #g-simon .si-pad:active { transform: scale(0.98); }
        #g-simon .si-pad.on { filter: brightness(1.55) saturate(1.2); box-shadow: 0 0 20px rgba(255,255,255,0.15); }
        #g-simon .si-green { background: linear-gradient(145deg, #1f8a3a, #0e3f1a); }
        #g-simon .si-red   { background: linear-gradient(145deg, #b02a2a, #4a0f0f); }
        #g-simon .si-blue  { background: linear-gradient(145deg, #2b63c9, #0f244a); }
        #g-simon .si-yellow{ background: linear-gradient(145deg, #caa71f, #4a3c0f); color: #111; text-shadow:none; }
        #g-simon .si-controls { display:flex; gap: 10px; flex-wrap: wrap; justify-content:center; }
        #g-simon .si-toggle {
            background: #111; border: 1px solid rgba(255,255,255,0.18);
            border-radius: 999px; padding: 8px 12px;
            display:flex; align-items:center; gap: 10px;
            font-weight: 900;
        }
        #g-simon .si-dot {
            width: 14px; height: 14px; border-radius: 50%;
            background: #444; box-shadow: 0 0 8px rgba(0,0,0,0.7);
            transition: background 0.2s, box-shadow 0.2s;
        }
        #g-simon .si-dot.on { background: #ff5252; box-shadow: 0 0 12px rgba(255,82,82,0.7); }
        #g-simon .si-hint { color: rgba(255,255,255,0.7); font-size: 13px; text-align:center; max-width: 520px; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    

        
        #g-minigolf { background: radial-gradient(circle at 30% 20%, #143312 0%, #000 75%); flex-direction: column; }
        #g-minigolf .mg-top {
            height: 60px; width: 100%;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.7); border-bottom: 1px solid rgba(255,255,255,0.15);
            box-sizing: border-box; padding: 0 12px; padding-left: 90px; gap: 10px;
        }
        #g-minigolf .mg-left, #g-minigolf .mg-right { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
        #g-minigolf .mg-pill {
            background: #1c3b1a; border: 1px solid rgba(255,255,255,0.18);
            padding: 6px 12px; border-radius: 999px; font-weight: 900; letter-spacing: 0.5px;
            display:flex; align-items:center; gap: 8px;
        }
        #g-minigolf .mg-pill span { font-family: monospace; color: #ffd700; }
        #g-minigolf .mg-btn {
            background: #21401e; border: 1px solid rgba(255,255,255,0.22);
            color: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 800;
        }
        #g-minigolf .mg-btn:active { transform: scale(0.98); }
        #g-minigolf .mg-wrap {
            flex: 1; display:flex; flex-direction: column;
            align-items:center; justify-content:center;
            padding: 12px; box-sizing:border-box; gap: 10px;
        }
        #g-minigolf .mg-canvas-wrap {
            flex: 1; width: 100%; max-width: 920px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--ui-border);
            border-radius: var(--ui-radius);
            overflow: hidden;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            position: relative;
        }
        #g-minigolf canvas { width: 100%; height: 100%; display:block; touch-action: none; }
        #g-minigolf .mg-bottom {
            width: 100%; max-width: 920px;
            display:flex; flex-direction: column; align-items:center; gap: 8px;
        }
        #g-minigolf .mg-power-row { display:flex; align-items:center; justify-content:center; gap: 10px; flex-wrap: wrap; width: 100%; }
        #g-minigolf .mg-bar {
            display: none; 
            width: min(360px, 92vw); height: 18px;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 999px; overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        #g-minigolf .mg-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #00e5ff, #ffd700, #ff5252);
            transition: width 0.03s;
        }
        #g-minigolf .mg-hint {
            color: rgba(255,255,255,0.75);
            font-size: 13px; text-align:center;
            max-width: 780px;
        }

        #g-minigolf #mg-hole-overlay,
        #g-minigolf #mg-round-overlay{
            
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            padding: 34px 18px;
            overflow: auto;
            justify-content: center;
            background: rgba(0,0,0,0.92);
            z-index: 120;
        }
        #g-minigolf #mg-hole-overlay .splash-title,
        #g-minigolf #mg-round-overlay .splash-title{ margin-top: 10px; }

        
        
        
        #g-minigolf .mg-power-row.mg-controls{
            justify-content: center;
            gap: 12px;
        }
        #g-minigolf .mg-stick{
            width: 92px; height: 92px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(0,0,0,0.22);
            box-shadow: inset 0 0 14px rgba(0,0,0,0.55), 0 0 18px rgba(0,0,0,0.35);
            position: relative;
            touch-action: none;
            user-select: none;
            flex: 0 0 auto;
        }
        #g-minigolf .mg-stick::after{
            content: "AIM";
            position:absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.55);
            font-weight: 900;
            pointer-events: none;
        }
        #g-minigolf .mg-stick-knob{
            width: 28px; height: 28px;
            border-radius: 50%;
            background: rgba(0,229,255,0.90);
            box-shadow: 0 0 12px rgba(0,229,255,0.35);
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #g-minigolf .mg-power-col{
            display:flex;
            flex-direction: column;
            align-items:center;
            gap: 6px;
        }
        #g-minigolf #mg-power-slider{
            width: min(300px, 78vw);
            accent-color: #00e5ff;
        }
        #g-minigolf .mg-btn.mg-shoot{
            background: rgba(0,229,255,0.22);
            border-color: rgba(0,229,255,0.55);
        }
@media (max-width: 640px){
            .menu-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 420px){
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
            .menu-title { font-size: 2.0rem; }
            .game-card { height: 84px; }
        }

        
#g-trail { background: radial-gradient(circle at 60% 30%, #1c1230, #050509); }
        #g-trail .trail-wrap{
            position: relative;
            width: 100%; height: 100%;
            padding-top: 48px;
            box-sizing: border-box;
        }
        #g-trail .trail-hud{
            position:absolute;
            left: 12px; right: 12px; top: 48px;
            background: rgba(0,0,0,0.28);
            border: 1px solid var(--ui-border);
            border-radius: var(--ui-radius);
            padding: 8px 10px;
            backdrop-filter: blur(6px);
            z-index: 5;
        }
        #g-trail .trail-title{ font-weight: 900; letter-spacing: 1px; font-size: 15px; }
        #g-trail .trail-sub{ margin-top: 4px; color:#cfcfcf; font-size: 0.82rem; }
        #g-trail .trail-row{ margin-top: 6px; display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
        #g-trail .trail-spacer{ flex: 1; }
        #g-trail .trail-mode{ padding: 10px 12px; font-size:  13px; }
        #g-trail .trail-action{ padding: 10px 12px; font-size:  13px; }
        #g-trail .trail-active{ background: rgba(0,229,255,0.20); border-color: rgba(0,229,255,0.52); }

        #g-trail .trail-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
        #g-trail .trail-top-actions{ display:flex; align-items:center; gap:10px; }
        #g-trail .trail-quick-next{ padding: 10px 14px; font-size: 13px; font-weight: 900; }
        #g-trail .trail-menu-btn{ padding: 10px 14px; font-size:  16px; line-height: 1; }
        #g-trail .trail-quick-erase{ padding: 10px 14px; font-size:  13px; font-weight: 900; }
        #g-trail .trail-hud.trail-collapsed{ padding: 6px 10px; }
        #g-trail .trail-hud.trail-collapsed .trail-sub,
        #g-trail .trail-hud.trail-collapsed .trail-row{ display:none; }
        #g-trail .trail-hud.trail-collapsed .trail-title{ font-size: 14px; }

        #trail-canvas{
            position:absolute; left:0; top:0;
            width: 100%; height: 100%;
            touch-action: none;
        }

        
        #g-orbslicer { background: radial-gradient(circle at 50% 18%, #1e90ff, #2b1055 60%, #050509); }
        #orb-canvas{
            position:absolute; left:0; top:0;
            width:100%; height:100%;
            touch-action:none;
        }
        #g-orbslicer .orb-ui{
            position:absolute;
            left: 12px; right: 12px; top: 48px;
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 10px;
            z-index: 8;
            pointer-events:none;
        }
        #g-orbslicer .orb-pill{
            background: rgba(0,0,0,0.28);
            border: 1px solid var(--ui-border);
            border-radius: 999px;
            padding: 8px 12px;
            font-weight: 900;
            font-size: 15px;
            letter-spacing: 0.6px;
            backdrop-filter: blur(6px);
            text-shadow: 0 2px 0 rgba(0,0,0,0.45);
            white-space: nowrap;
        }
        #g-orbslicer .orb-lives{
            color:#ff4d4d;
            font-size: 18px;
            letter-spacing: 1px;
        }
        #g-orbslicer .orb-bestline{
            color: rgba(255,255,255,0.72);
            font-weight: 900;
            letter-spacing: 1px;
            margin-top: -6px;
        }
        #g-orbslicer .orb-sub{
            max-width: 360px;
            text-align:center;
            color:#cfcfcf;
            font-size: 0.98rem;
            line-height: 1.25;
            padding: 0 18px;
        }

        #g-orbslicer .orb-diff{ display:flex; flex-direction:column; align-items:center; gap: 8px; margin-top: -6px; }
        #g-orbslicer .orb-diff-label{ font-size: 13px; font-weight: 900; letter-spacing: 1px; color: rgba(255,255,255,0.75); text-transform: uppercase; }
        #g-orbslicer .orb-diff-row{ display:flex; flex-wrap:wrap; justify-content:center; gap: 8px; padding: 0 18px; }
        #g-orbslicer .orb-diff-btn{ padding: 9px 12px; font-size: 13px; border-radius: 999px; }
        #g-orbslicer .orb-diff-btn.active{ background: rgba(0,229,255,0.20); border-color: rgba(0,229,255,0.55); }

.back-btn{
  position: fixed !important;
  top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
  left: calc(env(safe-area-inset-left, 0px) + 10px) !important;
  touch-action: none;
  cursor: grab;
}
.back-btn.dragging{ cursor: grabbing; }
#global-settings-btn{
  top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
  right: calc(env(safe-area-inset-right, 0px) + 10px) !important;
  touch-action: none;
  cursor: grab;
}
#global-settings-btn.dragging{ cursor: grabbing; }
.modal-screen{
  max-height: calc(100vh - 110px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: max(18px, env(safe-area-inset-bottom, 0px));
}
#global-settings-modal .settings-panel{
  max-height: calc(100vh - 28px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: max(12px, env(safe-area-inset-bottom, 0px));
}

        .back-btn.dragging, #global-settings-btn.dragging{ cursor: grabbing; }
        .back-btn, #global-settings-btn{ cursor: grab; touch-action: none; }
        .modal-screen{ max-height: calc(100vh - 120px); overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: max(16px, env(safe-area-inset-bottom, 0px)); }
        #global-settings-modal .settings-panel{ max-height: calc(100vh - 28px); overflow-y: auto; -webkit-overflow-scrolling: touch; }

.modal-screen{
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
#global-settings-modal .settings-panel{
  max-height: calc(100vh - 28px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
}
.back-btn{
  position: fixed !important;
  top: calc(env(safe-area-inset-top, 0px) + 10px) !important;
  left: calc(env(safe-area-inset-left, 0px) + 10px) !important;
  touch-action: none;
}
.back-btn.dragging, #global-settings-btn.dragging{ cursor: grabbing; }

        #g-dots .row{ flex-wrap: wrap; gap: 8px; }
        #g-dots .pill{ max-width: 100%; }
        #g-dots .status-pill{ justify-content:flex-start; gap:10px; min-width: 240px; flex: 1 1 260px; overflow:hidden; }
        #g-dots .turn-chip{ display:flex; align-items:center; gap:6px; flex:0 0 auto; }
        #g-dots .turn-label{ font-size:10px; color:#888; font-weight:700; letter-spacing:0.5px; }
        #g-dots #turnText{ font-weight:900; font-size:12px; letter-spacing:0.3px; }
        #g-dots #statusText{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
        #g-dots .menu-sub{ font-size:13px; color: rgba(255,255,255,0.75); max-width: 340px; text-align:center; line-height:1.25; margin-top:-6px; }
        #g-dots .dots-sec-title{ font-size:12px; color:#aaa; font-weight:700; margin-bottom:6px; letter-spacing:0.5px; }
        
        #g-dots .dots-colors{ margin-top: 4px; }
        #g-dots .dots-color-row{ display:flex; gap:14px; justify-content:center; flex-wrap: wrap; }
        #g-dots .dots-color-item{ display:flex; flex-direction:column; align-items:center; gap:6px; }
        #g-dots .dots-color-name{ font-size:12px; color:#ddd; font-weight:800; }
        #g-dots .dots-color-hint{ margin-top: 8px; font-size:11px; color:#9a9a9a; text-align:center; }
        #g-dots .dots-swatch-btn{
            display:flex; align-items:center; gap:10px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.28);
            color: #fff;
            padding: 8px 10px;
            cursor: pointer;
            min-width: 140px;
            justify-content:center;
            -webkit-tap-highlight-color: transparent;
        }
        #g-dots .dots-swatch-btn:active{ transform: scale(0.98); border-color: rgba(255,255,255,0.30); }
        #g-dots .dots-swatch-chip{
            width: 34px; height: 26px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.22);
            background: #444;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.25);
            flex: 0 0 auto;
        }
        #g-dots .dots-swatch-hex{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight: 900; font-size: 12px; letter-spacing: 0.5px; }

        
        #g-dots .dots-color-modal{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.78);
            backdrop-filter: blur(6px);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index: 2600;
            padding:
              max(18px, calc(env(safe-area-inset-top, 0px) + 12px))
              14px
              max(18px, calc(env(safe-area-inset-bottom, 0px) + 12px))
              14px;
        }
        #g-dots .dots-color-panel{
            width: min(520px, calc(100vw - 22px));
            background: rgba(20,20,20,0.94);
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 18px;
            padding: 12px 12px 10px 12px;
            box-shadow: 0 18px 48px rgba(0,0,0,0.55);
        }
        #g-dots .dots-color-head{
            display:flex; align-items:center; justify-content:space-between; gap: 10px;
            margin-bottom: 10px;
        }
        #g-dots .dots-color-title{
            font-weight: 1000;
            letter-spacing: 1px;
            color:#ffd700;
            text-shadow: 0 0 16px rgba(255,215,0,0.22);
        }
        #g-dots .dots-color-preview-row{
            display:flex; gap: 10px; align-items: stretch;
            margin-bottom: 10px;
        }
        #g-dots .dots-color-preview{
            width: 88px; border-radius: 14px;
            border: 2px solid rgba(255,255,255,0.20);
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.18);
            background: #444;
        }
        #g-dots .dots-color-hexwrap{ flex: 1; display:flex; flex-direction:column; gap: 6px; }
        #g-dots .dots-color-label{ font-size: 12px; color:#bdbdbd; font-weight: 900; letter-spacing: 0.8px; margin: 6px 0; }
        #g-dots .dots-color-hex{
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.22);
            background: rgba(0,0,0,0.30);
            color: #fff;
            padding: 12px 12px;
            font-size: 16px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-weight: 900;
            letter-spacing: 0.5px;
            box-sizing: border-box;
        }
        #g-dots .dots-color-sub{ font-size: 11px; color:#8f8f8f; }
        #g-dots .dots-color-palette{
            display:grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 6px;
        }
        #g-dots .dots-pal{
            height: 34px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.18);
            cursor:pointer;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.20);
            -webkit-tap-highlight-color: transparent;
        }
        #g-dots .dots-pal:active{ transform: scale(0.98); border-color: rgba(255,255,255,0.32); }

        #g-dots .dots-color-sliders{ display:flex; flex-direction:column; gap: 8px; }
        #g-dots .dots-slider-row{
            display:grid;
            grid-template-columns: 18px 1fr 44px;
            align-items:center;
            gap: 10px;
        }
        #g-dots .dots-slider-name{ font-weight: 900; color:#ddd; text-align:center; }
        #g-dots .dots-slider-val{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight: 900; color:#fff; text-align:right; }
        #g-dots input[type="range"]{ width: 100%; accent-color: var(--ui-accent); }

        #g-dots .dots-color-actions{
            display:flex; justify-content:flex-end; gap: 10px;
            margin-top: 12px;
        }

        @media (max-width: 420px){
            #g-dots .dots-color-palette{ grid-template-columns: repeat(5, 1fr); }
        }


        .splash-title{ color:#ffd700 !important; text-shadow:0 0 16px rgba(255,215,0,0.25) !important; }
        [id$="-menu"].overlay, #menuOverlay, #startOverlay, #cat-menu, #g-balloons .b-start-overlay{ background: rgba(0,0,0,0.95) !important; }
        #cat-menu .menu-title, #startOverlay .panel h1, #g-balloons .b-start-overlay h1{ color:#ffd700 !important; text-shadow:0 0 18px rgba(255,215,0,0.35) !important; }
        #startOverlay .big-btn, #startOverlay .small, #cat-menu .cat-btn, #g-balloons .b-start-overlay .btn-large-opt{ background:#333 !important; border:2px solid #555 !important; border-radius:15px !important; color:#fff !important; font-weight:900 !important; box-shadow:none !important; }
        #g-balloons .b-start-overlay .btn-large-opt{ font-size: 1.9rem !important; padding: 20px 28px !important; max-width: 320px; width: 80%; }
    

        
        #g-dots #menuOverlay,
        #g-dots #winnerOverlay{
            position: fixed !important;
            inset: 0 !important;
            border-radius: 0 !important;
            z-index: 2500 !important;
            padding:
              max(24px, calc(env(safe-area-inset-top, 0px) + 18px))
              18px
              max(24px, calc(env(safe-area-inset-bottom, 0px) + 18px))
              18px !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        #g-dots #menuOverlay .grid-options,
        #g-dots #menuOverlay .dots-mode-row,
        #g-dots #menuOverlay .dots-ai-row{
            width: min(320px, 92vw) !important;
        }

</style>
</head>
<body>

    <div id="feedback-overlay">
        <div id="feedback-content">AWESOME!</div>
        <canvas id="feedback-confetti" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
    </div>

    <button id="global-settings-btn" class="ui-btn" onclick="ArcadeSettings.openModal()" title="Settings" aria-label="Settings"></button>

    <div id="global-settings-modal" role="dialog" aria-modal="true" aria-label="Arcade settings">
        <div class="settings-panel">
            <div class="settings-head">
                <div class="settings-title">SETTINGS</div>
                <button class="ui-btn settings-close" onclick="ArcadeSettings.closeModal()"></button>
            </div>

            <div class="settings-row">
                <div class="label">
                    <div class="name">Sound</div>
                    <div class="desc">Mute all game sounds</div>
                </div>
                <input id="set-sound" type="checkbox" />
            </div>

            <div class="settings-row">
                <div class="label">
                    <div class="name">Reduced motion</div>
                    <div class="desc">Turns off most UI animations and win confetti.</div>
                </div>
                <input id="set-motion" type="checkbox" />
            </div>

            <div class="settings-row">
                <div class="label">
                    <div class="name">High contrast</div>
                    <div class="desc">Stronger borders + clearer UI. Also syncs Dots contrast.</div>
                </div>
                <input id="set-contrast" type="checkbox" />
            </div>

            <div class="settings-row">
                <div class="label">
                    <div class="name">Left-handed mode</div>
                    <div class="desc">Swaps the corner buttons (Menu + Settings).</div>
                </div>
                <input id="set-handed" type="checkbox" />
            </div>

            <div class="settings-actions">
                <button class="ui-btn" onclick="ArcadeSettings.reset()">Reset</button>
                <button class="ui-btn" onclick="ArcadeSettings.closeModal()">Done</button>
            </div>
        </div>
    </div>

    <div id="g-dots" class="game-view">
        <div class="wrap">
            <div class="top">
                <div class="row">
                    <button class="back-btn" style="position:static; margin-right:10px;" onclick="goToMenu()"> MENU</button>
                    <div style="font-weight:bold; font-size:16px;">Dots!</div>
                    <div>
                        <button id="contrastBtn" onclick="DotsGame.toggleContrast()" title="High contrast" aria-label="High contrast"></button>
                        <button id="undoBtn">Undo</button>
                        <button id="menuBtn">New Game</button>
                    </div>
                </div>
                <div class="row">
                    <div class="pill" id="scoreDisp">P1: 0 | P2: 0</div>
                    <div class="pill status-pill">
                        <div class="turn-chip">
                            <span class="turn-label">TURN</span>
                            <div id="turnDot"></div>
                            <span id="turnText">P1</span>
                        </div>
                        <span id="statusText">...</span>
                    </div>
                </div>
                <div class="row" style="justify-content:center; margin-top:5px;">
                    <div style="font-size:12px; color:#888;">OPEN BOXES: <span id="open-box-count" style="color:#fff; font-weight:bold;">0</span></div>
                </div>
            </div>
            <div class="boardBox" id="boardContainer">
                <canvas id="c"></canvas>
                <canvas id="dots-confetti-canvas"></canvas>
                <div id="combo-text">COMBO!</div>
                <div id="menuOverlay" class="overlay">
                    <h1 class="splash-title">DOTS</h1>
                    <div class="menu-sub">Pick a mode, choose colors, then pick a grid.</div>

                    <div class="dots-mode">
                        <div class="dots-sec-title">MODE</div>
                        <div class="dots-mode-row">
                            <button class="grid-btn dots-mode-btn" id="dotsModePvp" onclick="DotsGame.setMode('pvp')">2 Players</button>
                            <button class="grid-btn dots-mode-btn" id="dotsModeCpu" onclick="DotsGame.setMode('cpu')">vs. CPU</button>
                        </div>
                    </div>

                    <div id="dotsAiWrap" class="dots-ai" style="display:none;">
                        <div class="dots-sec-title">CPU DIFFICULTY</div>
                        <div class="dots-ai-row">
                            <button class="grid-btn dots-ai-btn" id="dotsAi1" onclick="DotsGame.setCpuLevel(1)">1</button>
                            <button class="grid-btn dots-ai-btn" id="dotsAi2" onclick="DotsGame.setCpuLevel(2)">2</button>
                            <button class="grid-btn dots-ai-btn" id="dotsAi3" onclick="DotsGame.setCpuLevel(3)">3</button>
                            <button class="grid-btn dots-ai-btn" id="dotsAi4" onclick="DotsGame.setCpuLevel(4)">4</button>
                            <button class="grid-btn dots-ai-btn" id="dotsAi5" onclick="DotsGame.setCpuLevel(5)">5</button>
                        </div>
                        <div style="font-size:11px;color:#888;margin-top:6px;max-width:260px;text-align:center;">1 = easy kid-level. 5 = tough adult-level.</div>
                    </div>

                    

                    
                    <div class="dots-colors">
                        <div class="dots-sec-title">COLORS</div>
                        <div class="dots-color-row">
                            <div class="dots-color-item">
                                <div class="dots-color-name" id="dotsP1Name">P1</div>
                                <button type="button" class="dots-swatch-btn" id="dotsP1Swatch" aria-label="Pick Player 1 color">
                                    <span class="dots-swatch-chip" id="dotsP1Chip"></span>
                                    <span class="dots-swatch-hex" id="dotsP1HexText">#FF3333</span>
                                </button>
                            </div>
                            <div class="dots-color-item">
                                <div class="dots-color-name" id="dotsP2Name">P2</div>
                                <button type="button" class="dots-swatch-btn" id="dotsP2Swatch" aria-label="Pick Player 2 color">
                                    <span class="dots-swatch-chip" id="dotsP2Chip"></span>
                                    <span class="dots-swatch-hex" id="dotsP2HexText">#3388FF</span>
                                </button>
                            </div>
                        </div>
                        <div class="dots-color-hint">Tap a swatch to pick a color (works in WebView too).</div>
                    </div>

                    <div id="dotsColorModal" class="dots-color-modal" style="display:none" role="dialog" aria-modal="true" aria-label="Pick a color">
                        <div class="dots-color-panel">
                            <div class="dots-color-head">
                                <div class="dots-color-title">PICK A COLOR</div>
                                <button class="ui-btn" type="button" id="dotsColorCloseBtn"></button>
                            </div>

                            <div class="dots-color-preview-row">
                                <div class="dots-color-preview" id="dotsColorPreview"></div>
                                <div class="dots-color-hexwrap">
                                    <div class="dots-color-label">HEX</div>
                                    <input id="dotsColorHex" class="dots-color-hex" type="text" inputmode="text" autocomplete="off" spellcheck="false" />
                                    <div class="dots-color-sub">Use #RRGGBB.</div>
                                </div>
                            </div>

                            <div class="dots-color-label">PALETTE</div>
                            <div class="dots-color-palette" id="dotsColorPalette"></div>

                            <div class="dots-color-label">MIX</div>
                            <div class="dots-color-sliders">
                                <div class="dots-slider-row">
                                    <span class="dots-slider-name">R</span>
                                    <input id="dotsR" type="range" min="0" max="255" value="255" />
                                    <span id="dotsRVal" class="dots-slider-val">255</span>
                                </div>
                                <div class="dots-slider-row">
                                    <span class="dots-slider-name">G</span>
                                    <input id="dotsG" type="range" min="0" max="255" value="51" />
                                    <span id="dotsGVal" class="dots-slider-val">51</span>
                                </div>
                                <div class="dots-slider-row">
                                    <span class="dots-slider-name">B</span>
                                    <input id="dotsB" type="range" min="0" max="255" value="51" />
                                    <span id="dotsBVal" class="dots-slider-val">51</span>
                                </div>
                            </div>

                            <div class="dots-color-actions">
                                <button class="ui-btn" type="button" id="dotsColorCancelBtn">Cancel</button>
                                <button class="ui-btn" type="button" id="dotsColorApplyBtn">Apply</button>
                            </div>
                        </div>
                    </div>

                    <div style="height:10px;"></div>

                    <div class="dots-sec-title">GRID</div>

                    <div class="grid-options">
                        <button class="grid-btn" onclick="DotsGame.startGame(5,5)">5 x 5 (Quick)</button>
                        <button class="grid-btn" onclick="DotsGame.startGame(8,8)">8 x 8 (Standard)</button>
                        <button class="grid-btn" onclick="DotsGame.startGame(10,10)">10 x 10 (Large)</button>
                        <button class="grid-btn" onclick="DotsGame.startGame(13,8)">8 x 13 (Full Screen)</button>
                    </div>
                </div>
                <div id="winnerOverlay" class="overlay" style="display:none">
                    <h2 id="winnerText">P1 WINS!</h2>
                    <button class="bigBtn" style="font-size:18px; padding:12px 30px; background:#228833; border:none; color:#fff; border-radius:8px;" id="playAgainBtn">Play Again</button>
                </div>
            </div>
        </div>
    </div>

<script>

    
    const ArcadeSettings = (function(){
        const KEY = "arcade_settings_v1";
        const defaults = { soundOn: true, reduceMotion: false, highContrast: false, swapCorners: false };
        let s = { ...defaults };
        const audioCtxs = new Set();

        function safeParse(raw){
            try{ return JSON.parse(raw); }catch(e){ return null; }
        }
        function load(){
            const raw = localStorage.getItem(KEY);
            const obj = raw ? safeParse(raw) : null;
            if(obj && typeof obj === 'object'){
                s = { ...s, ...obj };
            }
            apply();
        }
        function save(){
            try{ localStorage.setItem(KEY, JSON.stringify(s)); }catch(e){}
        }
        function apply(){
            document.body.classList.toggle('reduce-motion', !!s.reduceMotion);
            document.body.classList.toggle('high-contrast', !!s.highContrast);
            document.body.classList.toggle('swap-corners', !!s.swapCorners);

            
            audioCtxs.forEach(ctx => {
                try{
                    if(!ctx) return;
                    if(s.soundOn){
                        if(ctx.state === 'suspended') ctx.resume();
                    } else {
                        if(ctx.state === 'running') ctx.suspend();
                    }
                }catch(e){}
            });
        }
        function set(patch){
            s = { ...s, ...patch };
            save();
            apply();
            syncModal();
        }
        function reset(){
            s = { ...defaults };
            save();
            apply();
            syncModal();
        }
        function registerAudioCtx(ctx){
            if(!ctx) return;
            audioCtxs.add(ctx);
            apply();
        }

        function syncModal(){
            const modal = document.getElementById('global-settings-modal');
            const sound = document.getElementById('set-sound');
            const motion = document.getElementById('set-motion');
            const contrast = document.getElementById('set-contrast');
            const handed = document.getElementById('set-handed');
            if(!modal || !sound || !motion || !contrast || !handed) return;
            sound.checked = !!s.soundOn;
            motion.checked = !!s.reduceMotion;
            contrast.checked = !!s.highContrast;
            handed.checked = !!s.swapCorners;
        }

        function openModal(){
            const modal = document.getElementById('global-settings-modal');
            if(!modal) return;
            syncModal();
            modal.style.display = 'flex';
        }
        function closeModal(){
            const modal = document.getElementById('global-settings-modal');
            if(!modal) return;
            modal.style.display = 'none';
        }

        
        function initUI(){
            load();

            const modal = document.getElementById('global-settings-modal');
            const btn = document.getElementById('global-settings-btn');

            const sound = document.getElementById('set-sound');
            const motion = document.getElementById('set-motion');
            const contrast = document.getElementById('set-contrast');
            const handed = document.getElementById('set-handed');

            [sound, motion, contrast, handed].forEach(el => {
                if(!el) return;
                el.addEventListener('change', () => {
                    set({
                        soundOn: !!sound.checked,
                        reduceMotion: !!motion.checked,
                        highContrast: !!contrast.checked,
                        swapCorners: !!handed.checked
                    });
                });
            });

            if(modal){
                modal.addEventListener('click', (e) => {
                    if(e.target === modal) closeModal();
                });
            }

        }

        
        return {
            get soundOn(){ return !!s.soundOn; },
            get reduceMotion(){ return !!s.reduceMotion; },
            get highContrast(){ return !!s.highContrast; },
            get swapCorners(){ return !!s.swapCorners; },
            set, reset, apply, registerAudioCtx, openModal, closeModal, initUI
        };
    })(); 
    window.ArcadeSettings = ArcadeSettings;

    
    const ArcadeHaptics = (function(){
        function canVibe(){ return !!(navigator && navigator.vibrate); }
        function vibrate(pattern){
            try{ if(canVibe()) navigator.vibrate(pattern); }catch(e){}
        }
        function tap(){ vibrate(18); }
        function success(){ vibrate([18, 30, 40]); }
        function fail(){ vibrate(60); }
        function pop(type, rainbow){
            if(rainbow) return vibrate([12,20,12,20,12]);
            if(type === 'unicorn') return vibrate([18, 22, 18]);
            if(type === 'golden') return vibrate([28, 18, 28]);
            return vibrate(22);
        }
        function milestone(n){
            if(n >= 1000) return vibrate([30,40,30,40,60]);
            if(n % 500 === 0) return vibrate([22, 30, 22, 30, 40]);
            return vibrate(26);
        }
        function open(){ vibrate(22); }
        function back(){ vibrate(18); }

        
        function install(){
            document.addEventListener('pointerdown', (e) => {
                const btn = e.target && e.target.closest ? e.target.closest('button, .ui-btn, .menu-btn') : null;
                if(!btn) return;
                if(btn.disabled) return;
                
                if(btn.closest('canvas')) return;
                tap();
                
                try{ if(window.ArcadeFX) ArcadeFX.init(); }catch(err){}
            }, { passive: true });
        }

        return { tap, success, fail, pop, milestone, open, back, install };
    })();
    window.ArcadeHaptics = ArcadeHaptics;

    const ArcadeFX = (function(){
        let ctx = null;
        function enabled(){ return !(window.ArcadeSettings && !ArcadeSettings.soundOn); }
        function init(){
            try{
                if(!enabled()) return;
                if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
                if(window.ArcadeSettings) ArcadeSettings.registerAudioCtx(ctx);
                if(ctx.state === 'suspended') ctx.resume();
            }catch(e){}
        }
        function envGain(g, t, a=0.01, d=0.12){
            g.gain.setValueAtTime(0.0001, t);
            g.gain.exponentialRampToValueAtTime(0.25, t+a);
            g.gain.exponentialRampToValueAtTime(0.0001, t+d);
        }
        function ping(freq, t, dur=0.14, type='sine', vol=0.22){
            if(!ctx) return;
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, t);
            g.gain.setValueAtTime(0.0001, t);
            g.gain.exponentialRampToValueAtTime(vol, t+0.01);
            g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
            osc.connect(g); g.connect(ctx.destination);
            osc.start(t);
            osc.stop(t+dur+0.02);
        }
        function chord(freqs, t, dur=0.18, type='sine', vol=0.13){
            freqs.forEach(f => ping(f, t, dur, type, vol));
        }
        function play(name){
            init();
            if(!ctx) return;
            const t = ctx.currentTime + 0.001;

            switch(name){
                case 'success':
                    ping(523.25, t, 0.16, 'sine', 0.24);
                    ping(659.25, t+0.07, 0.16, 'sine', 0.22);
                    ping(783.99, t+0.14, 0.20, 'triangle', 0.20);
                    break;
                case 'fail':
                    ping(220, t, 0.22, 'square', 0.18);
                    ping(164.81, t+0.08, 0.26, 'square', 0.16);
                    break;
                case 'milestone':
                    chord([659.25, 783.99, 987.77], t, 0.20, 'triangle', 0.10);
                    ping(1318.51, t+0.08, 0.14, 'sine', 0.10);
                    break;
                case 'milestoneBig':
                    chord([523.25, 659.25, 783.99], t, 0.22, 'sine', 0.12);
                    chord([659.25, 783.99, 987.77], t+0.14, 0.24, 'triangle', 0.11);
                    break;
                case 'rainbowStart':
                    [880, 1108.73, 1318.51, 1760].forEach((f,i)=> ping(f, t+i*0.05, 0.14, 'sine', 0.12));
                    break;
                case 'rainbowEnd':
                    [1760, 1318.51, 1108.73, 880].forEach((f,i)=> ping(f, t+i*0.05, 0.14, 'triangle', 0.11));
                    break;
                case 'mega':
                    chord([392, 523.25, 659.25], t, 0.24, 'sine', 0.12);
                    chord([523.25, 659.25, 783.99], t+0.18, 0.26, 'triangle', 0.11);
                    ping(1046.5, t+0.32, 0.30, 'sine', 0.12);
                    break;

                case 'slice':
                    
                    ping(1046.5, t, 0.06, 'triangle', 0.10);
                    ping(1318.51, t+0.02, 0.07, 'sine', 0.09);
                    break;
                case 'boom':
                    ping(146.83, t, 0.22, 'square', 0.16);
                    ping(110, t+0.06, 0.26, 'square', 0.14);
                    break;
                case 'heal':
                    chord([523.25, 659.25, 783.99], t, 0.18, 'sine', 0.10);
                    ping(1046.5, t+0.10, 0.16, 'triangle', 0.10);
                    break;

                default:
                    break;
            }
        }
        return { init, play };
    })();
    window.ArcadeFX = ArcadeFX;

    try{ ArcadeHaptics.install(); }catch(e){}

    const ArcadeStore = (function(){
        const prefix = "arcade_";
        const k = (key) => prefix + key;

        function getRaw(key){
            try{ return localStorage.getItem(k(key)); }catch(e){ return null; }
        }
        function setRaw(key, val){
            try{ localStorage.setItem(k(key), val); }catch(e){}
        }

        function getNum(key, def=0){
            const raw = getRaw(key);
            const n = raw == null ? NaN : Number(raw);
            return Number.isFinite(n) ? n : def;
        }
        function setNum(key, num){
            const n = Number(num);
            if(!Number.isFinite(n)) return;
            setRaw(key, String(n));
        }

        function getStr(key, def=""){
            const raw = getRaw(key);
            return raw == null ? def : String(raw);
        }
        function setStr(key, val){
            setRaw(key, String(val));
        }

        function getJSON(key, def=null){
            const raw = getRaw(key);
            if(!raw) return def;
            try{ return JSON.parse(raw); }catch(e){ return def; }
        }
        function setJSON(key, obj){
            try{ setRaw(key, JSON.stringify(obj)); }catch(e){}
        }

        function del(key){
            try{ localStorage.removeItem(k(key)); }catch(e){}
        }

        return { getNum, setNum, getStr, setStr, getJSON, setJSON, del };
    })();
    window.ArcadeStore = ArcadeStore;

    let currentGameId = null;
    ArcadeSettings.initUI();

    
    function openGame(_id) {  }
    function goToMenu() { try{ ArcadeSettings.closeModal(); }catch(e){} window.location.href = 'index.html'; }

const FeedbackSys = (function(){
        const overlay = document.getElementById('feedback-overlay');
        const text = document.getElementById('feedback-content');
        const canvas = document.getElementById('feedback-confetti');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animId = null;
        let active = false;

        function show(isWin) {
            
            if(show._t) { clearTimeout(show._t); show._t = null; }
            if(animId) { cancelAnimationFrame(animId); animId = null; }
            active = true;

            overlay.style.display = 'flex';
        try{ if(typeof syncDifficultyUI === 'function') syncDifficultyUI(); }catch(e){}
            text.className = isWin ? 'fb-win' : 'fb-loss';
            text.textContent = isWin ? "AWESOME!" : "";
            try{ if(window.ArcadeFX) ArcadeFX.play(isWin ? 'success' : 'fail'); }catch(e){}
            try{ if(window.ArcadeHaptics) { if(isWin) ArcadeHaptics.success(); else ArcadeHaptics.fail(); } }catch(e){}
            particles = [];

            if(isWin && !(window.ArcadeSettings && ArcadeSettings.reduceMotion)) {
                spawnConfetti();
                loop();
            } else {
                ctx.clearRect(0,0,canvas.width,canvas.height);
            }

            show._t = setTimeout(() => {
                overlay.style.display = 'none';
                if(animId) cancelAnimationFrame(animId);
                animId = null;
                active = false;
                show._t = null;
            }, 1500);
        }

        function spawnConfetti() {
            canvas.width = overlay.clientWidth; canvas.height = overlay.clientHeight;
            for(let i=0; i<100; i++) {
                particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                    c: ['#f00','#0f0','#00f','#ff0','#0ff','#f0f'][Math.floor(Math.random()*6)],
                    size: Math.random()*8+4
                });
            }
        }

        function loop() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => {
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5;
                ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,p.size,p.size);
            });
            animId = requestAnimationFrame(loop);
        }

        return { show };
    })();

    const DotsGame = (function(){
        let DR = 8, DC = 8, BR = 7, BC = 7, TOTAL = 49;
        let C_P1 = "#FF3333", C_P2 = "#3388FF";
        const C_GRID = "#444444", C_DOT = "#FFFFFF", C_SEL = "#FFD700";
        let HO, VO, boxOwner, turn, s1, s2, claimed, history, sel, lastMove;
        let boxAnim = [], particles = [];
        let PAD, DOT_R, DOT_HIT, LINE_W, STEP, OX, OY;
        let highContrast = false; 
        function syncGlobalContrast(){
            
            highContrast = document.body.classList.contains('high-contrast');
        }
let mode = 'pvp';
        let cpuLevel = 3;
        let cpuThinking = false;
        let cpuTimer = null;
        
        const canvas = document.getElementById("c");
        const ctx = canvas.getContext("2d");
        const boardContainer = document.getElementById("boardContainer");
        const statusText = document.getElementById("statusText");
        const turnText = document.getElementById("turnText");
        const p1NameEl = document.getElementById("dotsP1Name");
        const p2NameEl = document.getElementById("dotsP2Name");
        const p1SwatchBtn = document.getElementById("dotsP1Swatch");
        const p2SwatchBtn = document.getElementById("dotsP2Swatch");
        const p1Chip = document.getElementById("dotsP1Chip");
        const p2Chip = document.getElementById("dotsP2Chip");
        const p1HexText = document.getElementById("dotsP1HexText");
        const p2HexText = document.getElementById("dotsP2HexText");

        const colorModal = document.getElementById("dotsColorModal");
        const colorPalette = document.getElementById("dotsColorPalette");
        const colorPreview = document.getElementById("dotsColorPreview");
        const colorHex = document.getElementById("dotsColorHex");
        const colorCloseBtn = document.getElementById("dotsColorCloseBtn");
        const colorCancelBtn = document.getElementById("dotsColorCancelBtn");
        const colorApplyBtn = document.getElementById("dotsColorApplyBtn");
        const rSlider = document.getElementById("dotsR");
        const gSlider = document.getElementById("dotsG");
        const bSlider = document.getElementById("dotsB");
        const rVal = document.getElementById("dotsRVal");
        const gVal = document.getElementById("dotsGVal");
        const bVal = document.getElementById("dotsBVal");

        function normColor(v, fallback){
            if(typeof v !== "string") return fallback;
            const s = v.trim();
            return /^#[0-9a-fA-F]{6}$/.test(s) ? s.toUpperCase() : fallback;
        }

        

        function hexToRgb(hex){
            const m = /^#?([0-9a-fA-F]{6})$/.exec(String(hex||""));
            if(!m) return {r:255,g:255,b:255};
            const n = parseInt(m[1], 16);
            return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
        }
        function relLum(hex){
            const {r,g,b} = hexToRgb(hex);
            const sr = r/255, sg = g/255, sb = b/255;
            const f = (c)=> (c<=0.03928) ? (c/12.92) : Math.pow((c+0.055)/1.055, 2.4);
            const R=f(sr), G=f(sg), B=f(sb);
            return 0.2126*R + 0.7152*G + 0.0722*B;
        }
        function dashOverlayColor(baseHex){
            const L = relLum(baseHex);
            return (L > 0.55) ? '#000000' : '#FFFFFF';
        }

        function rgbToHex(r,g,b){
            const to2 = (n)=> ("0" + Math.max(0, Math.min(255, n|0)).toString(16)).slice(-2);
            return "#" + to2(r) + to2(g) + to2(b);
        }

        const PALETTE = [
            "#FF3333","#3388FF","#FFD400","#19E68C","#B84DFF","#FF6AD5",
            "#FF7A00","#00D6FF","#00FF5A","#7CFF00","#00A3FF","#FF2E88",
            "#9DFFFD","#C8A3FF","#FFFFFF","#1B1B1B",
            "#7D2EFF","#5CFFB7","#FFB347","#FF4D4D","#4DFFFE","#9AFF4D",
            "#FF4DF2","#4D7DFF","#E6FF4D","#FF9A4D","#4DFF88","#FF4D9A"
        ];

        let _colorTarget = 1; 
        let _temp = { r:255, g:51, b:51 };

        function setModalFromHex(hex){
            const h = normColor(hex, "#FFFFFF");
            const {r,g,b} = hexToRgb(h);
            _temp = {r,g,b};
            if(rSlider) rSlider.value = String(r);
            if(gSlider) gSlider.value = String(g);
            if(bSlider) bSlider.value = String(b);
            if(rVal) rVal.textContent = String(r);
            if(gVal) gVal.textContent = String(g);
            if(bVal) bVal.textContent = String(b);
            const hx = rgbToHex(r,g,b);
            if(colorHex) colorHex.value = hx;
            if(colorPreview) colorPreview.style.background = hx;
        }

        function applyModalFromSliders(){
            const r = parseInt(rSlider?.value || "0", 10) || 0;
            const g = parseInt(gSlider?.value || "0", 10) || 0;
            const b = parseInt(bSlider?.value || "0", 10) || 0;
            if(rVal) rVal.textContent = String(r);
            if(gVal) gVal.textContent = String(g);
            if(bVal) bVal.textContent = String(b);
            const hx = rgbToHex(r,g,b);
            if(colorHex) colorHex.value = hx;
            if(colorPreview) colorPreview.style.background = hx;
            _temp = {r,g,b};
        }

        function openColorModal(which){
            _colorTarget = (which===2) ? 2 : 1;
            if(!colorModal) return;
            const current = (_colorTarget===1) ? C_P1 : C_P2;
            setModalFromHex(current);
            colorModal.style.display = "flex";
        }

        function closeColorModal(){
            if(!colorModal) return;
            colorModal.style.display = "none";
        }

        function applyColorModal(){
            const h = normColor(colorHex?.value || "", (_colorTarget===1)?C_P1:C_P2);
            setPlayerColor(_colorTarget, h, true);
            closeColorModal();
        }

        function buildPalette(){
            if(!colorPalette) return;
            colorPalette.innerHTML = "";
            PALETTE.forEach(hex => {
                const b = document.createElement("button");
                b.type = "button";
                b.className = "dots-pal";
                b.style.background = hex;
                b.setAttribute("aria-label", "Pick " + hex);
                b.addEventListener("click", () => setModalFromHex(hex));
                colorPalette.appendChild(b);
            });
        }

        function initColorPickerUI(){
            buildPalette();

            if(p1SwatchBtn) p1SwatchBtn.addEventListener("click", () => openColorModal(1));
            if(p2SwatchBtn) p2SwatchBtn.addEventListener("click", () => openColorModal(2));

            const onSlider = ()=> applyModalFromSliders();
            if(rSlider) rSlider.addEventListener("input", onSlider);
            if(gSlider) gSlider.addEventListener("input", onSlider);
            if(bSlider) bSlider.addEventListener("input", onSlider);

            if(colorHex) colorHex.addEventListener("input", () => {
                const v = String(colorHex.value || "").trim();
                if(/^#?[0-9a-fA-F]{6}$/.test(v)){
                    const h = v.startsWith("#") ? v : ("#" + v);
                    setModalFromHex(h);
                }
            });

            if(colorCloseBtn) colorCloseBtn.addEventListener("click", closeColorModal);
            if(colorCancelBtn) colorCancelBtn.addEventListener("click", closeColorModal);
            if(colorApplyBtn) colorApplyBtn.addEventListener("click", applyColorModal);

            if(colorModal){
                colorModal.addEventListener("click", (e) => {
                    if(e.target === colorModal) closeColorModal();
                });
            }

            window.addEventListener("keydown", (e) => {
                if(e.key === "Escape" && colorModal && colorModal.style.display !== "none") closeColorModal();
            }, { passive: true });

            
            try{
                const saved = ArcadeStore.getJSON('dots_colors', null);
                if(saved && typeof saved === 'object'){
                    if(saved.p1) C_P1 = normColor(saved.p1, C_P1);
                    if(saved.p2) C_P2 = normColor(saved.p2, C_P2);
                }
            }catch(e){}

            
            setPlayerColor(1, C_P1, false);
            setPlayerColor(2, C_P2, false);
        }

function syncColorLabels(){
            if(p1NameEl) p1NameEl.textContent = (mode==='cpu') ? 'YOU' : 'P1';
            if(p2NameEl) p2NameEl.textContent = (mode==='cpu') ? 'CPU' : 'P2';
        }

        function syncPickedColors(){
            const p1 = normColor((p1HexText && p1HexText.textContent) ? p1HexText.textContent : C_P1, C_P1);
            const p2 = normColor((p2HexText && p2HexText.textContent) ? p2HexText.textContent : C_P2, C_P2);
            setPlayerColor(1, p1, false);
            setPlayerColor(2, p2, false);
        }

        function setPlayerColor(which, hex, redraw=true){
            const c = normColor(hex, which===1 ? C_P1 : C_P2);
            if(which === 1){
                C_P1 = c;
                if(p1Chip) p1Chip.style.background = c;
                if(p1HexText) p1HexText.textContent = c;
            }else{
                C_P2 = c;
                if(p2Chip) p2Chip.style.background = c;
                if(p2HexText) p2HexText.textContent = c;
            }
            try{
                ArcadeStore.setJSON('dots_colors', { p1: C_P1, p2: C_P2 });
            }catch(e){}
            try{ updateUI(); }catch(e){}
            if(redraw) requestAnimationFrame(draw);
        }
        const turnDot = document.getElementById("turnDot");
        const scoreEl = document.getElementById("scoreDisp");
        const undoBtn = document.getElementById("undoBtn");
        const menuOverlay = document.getElementById("menuOverlay");
        const winnerOverlay = document.getElementById("winnerOverlay");
        const winnerText = document.getElementById("winnerText");
        const openBoxCount = document.getElementById("open-box-count");
        const modePvpBtn = document.getElementById("dotsModePvp");
        const modeCpuBtn = document.getElementById("dotsModeCpu");
        const aiWrap = document.getElementById("dotsAiWrap");
        const aiBtns = [1,2,3,4,5].map(n => document.getElementById(`dotsAi${n}`));
        
        function mk2(r,c,val){ let a=[]; for(let i=0;i<r;i++){ let row=[]; for(let j=0;j<c;j++) row.push(val); a.push(row); } return a; }
        function copy2(a){ return a.map(r => r.slice()); }
        function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

        function toggleContrast() {
            const next = !document.body.classList.contains('high-contrast');
            document.body.classList.toggle('high-contrast', next);
            highContrast = next;
            try{ if(window.ArcadeSettings) ArcadeSettings.set({ highContrast: next }); }catch(e){}
            requestAnimationFrame(draw);
        }

        function stopCpu(){
            if(cpuTimer){ clearTimeout(cpuTimer); cpuTimer = null; }
            cpuThinking = false;
        }

        function syncMenuUI(){
            if(!modePvpBtn || !modeCpuBtn) return;
            modePvpBtn.classList.toggle('dots-sel', mode==='pvp');
            modeCpuBtn.classList.toggle('dots-sel', mode==='cpu');
            if(aiWrap) aiWrap.style.display = (mode==='cpu') ? 'block' : 'none';
            aiBtns.forEach((b, idx) => { if(b) b.classList.toggle('dots-sel', cpuLevel === (idx+1)); });
            syncColorLabels();
        }

        function setMode(m){
            mode = (m === 'cpu') ? 'cpu' : 'pvp';
            syncMenuUI();
        }

        function setCpuLevel(l){
            cpuLevel = Math.max(1, Math.min(5, l|0));
            syncMenuUI();
        }

        function openNewGameMenu(){
            stopCpu();
            syncGlobalContrast();
            syncPickedColors();
            menuOverlay.style.display = 'flex';
            winnerOverlay.style.display = 'none';
            syncMenuUI();
            status("Pick a mode, choose colors, then pick a grid");
        }

        function startGame(rows, cols){
            stopCpu();
            syncGlobalContrast();
            syncPickedColors();
            DR = rows; DC = cols; BR = rows - 1; BC = cols - 1; TOTAL = BR * BC;
            HO = mk2(DR, BC, 0); VO = mk2(BR, DC, 0);
            boxOwner = mk2(BR, BC, 0); boxAnim = mk2(BR, BC, 0);
            turn = 1; s1 = 0; s2 = 0; claimed = 0; history = []; sel = null; lastMove = null; particles = [];
            menuOverlay.style.display = 'none'; winnerOverlay.style.display = 'none';
            syncMenuUI();
            status(mode === 'cpu' ? "Your move." : "Start!");
            updateUI(); fitCanvas();
        }

        function quit() {
            stopCpu();
            syncGlobalContrast();
            menuOverlay.style.display = 'flex';
            winnerOverlay.style.display = 'none';
            HO = null; VO = null; boxOwner = null;
            syncMenuUI();
            status("Pick a mode, choose colors, then pick a grid");
        }

        function saveStateHistory(){
            if(history.length > 50) history.shift();
            history.push({ HO: copy2(HO), VO: copy2(VO), boxOwner: copy2(boxOwner), boxAnim: copy2(boxAnim), turn: turn, s1: s1, s2: s2, claimed: claimed, lastMove: lastMove ? {...lastMove} : null });
            updateUI();
        }

        function undo(){
            if(!history.length) return;
            stopCpu();
            let s = history.pop();
            HO=copy2(s.HO); VO=copy2(s.VO); boxOwner=copy2(s.boxOwner); boxAnim=copy2(s.boxAnim);
            turn=s.turn; s1=s.s1; s2=s.s2; claimed=s.claimed; lastMove=s.lastMove; sel=null;
            winnerOverlay.style.display = 'none'; updateUI(); status("Undid last move"); fitCanvas();
            if(mode === 'cpu' && turn === 2 && claimed !== TOTAL){ maybeCpu(); }
        }

        function updateUI(){
            const p1n = (mode==='cpu') ? 'YOU' : 'P1';
            const p2n = (mode==='cpu') ? 'CPU' : 'P2';
            scoreEl.innerHTML = `<span style='color:${C_P1}'>${p1n}: ${s1}</span> | <span style='color:${C_P2}'>${p2n}: ${s2}</span>`;
            undoBtn.disabled = (history.length === 0);
            let color = (turn === 1) ? C_P1 : C_P2;
            turnDot.style.background = color; turnDot.style.boxShadow = "0 0 8px " + color;
            if(turnText) turnText.textContent = (turn===1)?p1n:p2n;
            openBoxCount.textContent = `${TOTAL - claimed} / ${TOTAL}`;
        }
        function status(msg){ statusText.textContent = msg; }

        function fitCanvas(){
            if(currentGameId !== 'dots') return;
            let dpr = window.devicePixelRatio || 1;
            let w = boardContainer.clientWidth; let h = boardContainer.clientHeight;
            let stepX = (w*0.95) / (DC - 1); let stepY = (h*0.95) / (DR - 1);
            let rawStep = Math.min(stepX, stepY);
            let pad = rawStep * 0.7;
            canvas.style.width = Math.floor(rawStep*(DC-1)+pad*2)+"px";
            canvas.style.height = Math.floor(rawStep*(DR-1)+pad*2)+"px";
            canvas.width = Math.floor((rawStep*(DC-1)+pad*2) * dpr);
            canvas.height = Math.floor((rawStep*(DR-1)+pad*2) * dpr);
            STEP = rawStep * dpr; PAD = pad * dpr; OX = PAD; OY = PAD;
            DOT_R = STEP * 0.15; DOT_HIT = STEP * 0.45; LINE_W = STEP * 0.18; 
            const cc = document.getElementById('dots-confetti-canvas');
            cc.width = w * dpr; cc.height = h * dpr;
        }

        function getXY(r, c){ return { x: OX + c*STEP, y: OY + r*STEP }; }
        function pickDot(ex, ey){
            let rect = canvas.getBoundingClientRect();
            let x = (ex - rect.left) * (canvas.width / rect.width);
            let y = (ey - rect.top) * (canvas.height / rect.height);
            let best = null, minD2 = DOT_HIT * DOT_HIT;
            for(let r=0; r<DR; r++){
                for(let c=0; c<DC; c++){
                    let p = getXY(r,c); let d2 = (x-p.x)*(x-p.x) + (y-p.y)*(y-p.y);
                    if(d2 < minD2){ minD2 = d2; best = {r:r, c:c}; }
                }
            }
            return best;
        }

        function isNeighbor(d1, d2){ return (Math.abs(d1.r - d2.r) + Math.abs(d1.c - d2.c) === 1); }

        function makeMove(d1, d2){
            let type = (d1.r === d2.r) ? 'H' : 'V';
            let r = (type==='H') ? d1.r : Math.min(d1.r, d2.r);
            let c = (type==='H') ? Math.min(d1.c, d2.c) : d1.c;
            if( (type==='H' ? HO[r][c] : VO[r][c]) !== 0 ) return false;
            saveStateHistory(); 
            let p = turn;
            if(type==='H') HO[r][c] = p; else VO[r][c] = p;
            lastMove = {type:type, r:r, c:c};
            let points = 0;
            function check(br, bc){
                if(br<0||bc<0||br>=BR||bc>=BC) return 0;
                if(boxOwner[br][bc]!==0) return 0;
                if(HO[br][bc] && HO[br+1][bc] && VO[br][bc] && VO[br][bc+1]){
                    boxOwner[br][bc] = p; boxAnim[br][bc] = Date.now(); return 1;
                }
                return 0;
            }
            if(type === 'H'){ points += check(r-1, c); points += check(r, c); }
            else { points += check(r, c-1); points += check(r, c); }
            if(points > 0){
                if(p===1) s1 += points; else s2 += points;
                const p1n = (mode==='cpu') ? 'YOU' : 'P1';
                const p2n = (mode==='cpu') ? 'CPU' : 'P2';
                claimed += points; status((p===1?p1n:p2n) + ' scored!'); vibrate(50);
                
                if(points > 1) {
                    const ct = document.getElementById('combo-text');
                    ct.classList.remove('combo-anim');
                    void ct.offsetWidth; 
                    ct.classList.add('combo-anim');
                }
            } else {
                turn = (turn===1) ? 2 : 1; status("Make a move"); vibrate(10); 
            }
            if(claimed === TOTAL){
                setTimeout(()=>{
                    const p1n = (mode==='cpu') ? 'YOU' : 'P1';
                    const p2n = (mode==='cpu') ? 'CPU' : 'P2';
                    let winner = (s1>s2) ? `${p1n} WINS!` : (s2>s1) ? `${p2n} WINS!` : 'TIE GAME';
                    winnerText.textContent = winner;
                    winnerText.style.color = (s1>s2)?C_P1 : (s2>s1)?C_P2 : "#FFF";
                    winnerOverlay.style.display = 'flex'; lastMove = null; spawnConfetti();
                }, 500);
            }
            updateUI();
            if(mode === 'cpu' && turn === 2 && claimed !== TOTAL){ maybeCpu(); }
            return true;
        }

        function listMoves(state){
            const moves = [];
            for(let r=0; r<DR; r++){
                for(let c=0; c<BC; c++){
                    if(state.HO[r][c] === 0) moves.push({type:'H', r, c});
                }
            }
            for(let r=0; r<BR; r++){
                for(let c=0; c<DC; c++){
                    if(state.VO[r][c] === 0) moves.push({type:'V', r, c});
                }
            }
            return moves;
        }

        function cloneState(s){
            return {
                HO: copy2(s.HO),
                VO: copy2(s.VO),
                boxOwner: copy2(s.boxOwner),
                turn: s.turn,
                s1: s.s1,
                s2: s.s2,
                claimed: s.claimed
            };
        }

        function globalsToState(){
            return {
                HO: copy2(HO),
                VO: copy2(VO),
                boxOwner: copy2(boxOwner),
                turn: turn,
                s1: s1,
                s2: s2,
                claimed: claimed
            };
        }

        function boxSides(s, br, bc){
            return (s.HO[br][bc] ? 1 : 0)
                + (s.HO[br+1][bc] ? 1 : 0)
                + (s.VO[br][bc] ? 1 : 0)
                + (s.VO[br][bc+1] ? 1 : 0);
        }

        function countThree(s){
            let n = 0;
            for(let r=0; r<BR; r++){
                for(let c=0; c<BC; c++){
                    if(s.boxOwner[r][c] !== 0) continue;
                    if(boxSides(s, r, c) === 3) n++;
                }
            }
            return n;
        }

        function applyMoveInPlace(s, mv){
            const p = s.turn;
            if(mv.type === 'H') s.HO[mv.r][mv.c] = p;
            else s.VO[mv.r][mv.c] = p;

            let points = 0;
            function check(br, bc){
                if(br < 0 || bc < 0 || br >= BR || bc >= BC) return 0;
                if(s.boxOwner[br][bc] !== 0) return 0;
                if(s.HO[br][bc] && s.HO[br+1][bc] && s.VO[br][bc] && s.VO[br][bc+1]){
                    s.boxOwner[br][bc] = p;
                    return 1;
                }
                return 0;
            }
            if(mv.type === 'H'){ points += check(mv.r-1, mv.c); points += check(mv.r, mv.c); }
            else { points += check(mv.r, mv.c-1); points += check(mv.r, mv.c); }

            if(points > 0){
                if(p === 1) s.s1 += points; else s.s2 += points;
                s.claimed += points;
            } else {
                s.turn = (p === 1) ? 2 : 1;
            }
            return points;
        }

        function evaluateState(s){
            const diff = (s.s2 - s.s1);
            let v = diff * 100;
            if(s.claimed === TOTAL){
                if(diff > 0) v += 1000000;
                else if(diff < 0) v -= 1000000;
            }
            const three = countThree(s);
            v += (s.turn === 2 ? three * 6 : -three * 6);
            return v;
        }

        function pickRandom(arr){
            return arr[(Math.random() * arr.length) | 0];
        }

        function minimax(s, depth, alpha, beta, topK){
            if(depth <= 0 || s.claimed === TOTAL) return evaluateState(s);

            const moves = listMoves(s);
            if(!moves.length) return evaluateState(s);

            
            const scored = moves.map(mv => {
                const ns = cloneState(s);
                const pts = applyMoveInPlace(ns, mv);
                let v = evaluateState(ns) + pts * 500;
                return { mv, v };
            });

            if(s.turn === 2) scored.sort((a,b)=>b.v-a.v);
            else scored.sort((a,b)=>a.v-b.v);

            const consider = scored.slice(0, Math.max(1, Math.min(topK, scored.length)));

            if(s.turn === 2){
                let best = -Infinity;
                for(const it of consider){
                    const ns = cloneState(s);
                    applyMoveInPlace(ns, it.mv);
                    const val = minimax(ns, depth-1, alpha, beta, Math.max(6, Math.floor(topK*0.75)));
                    best = Math.max(best, val);
                    alpha = Math.max(alpha, best);
                    if(beta <= alpha) break;
                }
                return best;
            } else {
                let best = Infinity;
                for(const it of consider){
                    const ns = cloneState(s);
                    applyMoveInPlace(ns, it.mv);
                    const val = minimax(ns, depth-1, alpha, beta, Math.max(6, Math.floor(topK*0.75)));
                    best = Math.min(best, val);
                    beta = Math.min(beta, best);
                    if(beta <= alpha) break;
                }
                return best;
            }
        }

        function chooseCpuMove(level){
            const base = globalsToState();
            const moves = listMoves(base);
            if(!moves.length) return null;

            if(level <= 1){
                return pickRandom(moves);
            }

            if(level === 2){
                const safe = [];
                for(const mv of moves){
                    const ns = cloneState(base);
                    const pts = applyMoveInPlace(ns, mv);
                    if(pts > 0) { safe.push(mv); continue; }
                    if(countThree(ns) === 0) safe.push(mv);
                }
                return safe.length ? pickRandom(safe) : pickRandom(moves);
            }

            
            if(level === 3){
                let bestV = -Infinity;
                let best = [];
                for(const mv of moves){
                    const ns = cloneState(base);
                    const pts = applyMoveInPlace(ns, mv);
                    const three = countThree(ns);
                    let v = (ns.s2 - ns.s1) * 1000 + pts * 2000;
                    
                    if(ns.turn === 1) v -= three * 400;
                    if(v > bestV + 0.0001){ bestV = v; best = [mv]; }
                    else if(Math.abs(v - bestV) < 0.0001){ best.push(mv); }
                }
                return pickRandom(best.length ? best : moves);
            }

            
            const remainingMoves = moves.length;
            let depth = (level === 4) ? 2 : 2;
            let topK = (level === 4) ? 14 : 16;

            if(level === 5){
                
                if(remainingMoves <= 70) { depth = 3; topK = 10; }
                if(remainingMoves <= 45) { depth = 4; topK = 10; }
                if(remainingMoves > 120) { depth = 2; topK = 14; }
            }

            let bestV = -Infinity;
            let best = [];
            
            const rootScored = moves.map(mv => {
                const ns = cloneState(base);
                const pts = applyMoveInPlace(ns, mv);
                let v = evaluateState(ns) + pts * 800;
                
                if(ns.turn === 1) v -= countThree(ns) * 120;
                return { mv, v };
            }).sort((a,b)=>b.v-a.v).slice(0, topK);

            for(const it of rootScored){
                const ns = cloneState(base);
                applyMoveInPlace(ns, it.mv);
                const val = minimax(ns, depth-1, -Infinity, Infinity, topK);
                if(val > bestV + 0.0001){ bestV = val; best = [it.mv]; }
                else if(Math.abs(val - bestV) < 0.0001){ best.push(it.mv); }
            }

            
            if(best.length > 1 && level === 4) best = best.slice(0, Math.min(3, best.length));
            if(best.length > 1 && level === 5) best = best.slice(0, Math.min(2, best.length));

            return pickRandom(best.length ? best : moves);
        }

        function cpuStep(){
            if(currentGameId !== 'dots' || mode !== 'cpu' || turn !== 2 || claimed === TOTAL) { cpuThinking = false; return; }
            const mv = chooseCpuMove(cpuLevel);
            if(!mv){ cpuThinking = false; return; }

            const d1 = { r: mv.r, c: mv.c };
            const d2 = (mv.type === 'H')
                ? { r: mv.r, c: mv.c + 1 }
                : { r: mv.r + 1, c: mv.c };

            cpuThinking = false;
            makeMove(d1, d2);

            if(mode === 'cpu' && turn === 2 && claimed !== TOTAL){
                maybeCpu(); 
            } else if(mode === 'cpu' && claimed !== TOTAL){
                status("Your turn");
            }
        }

        function maybeCpu(){
            stopCpu();
            if(currentGameId !== 'dots' || mode !== 'cpu' || claimed === TOTAL || turn !== 2) return;
            cpuThinking = true;
            status("CPU thinking");
            const delay = 240 + cpuLevel * 60;
            cpuTimer = setTimeout(cpuStep, delay);
        }

        let isDrag = false;
        function getEventPos(ev){
            let ex = ev.clientX, ey = ev.clientY;
            if(ex === undefined && ev.touches && ev.touches.length > 0){ ex = ev.touches[0].clientX; ey = ev.touches[0].clientY; }
            return {x:ex, y:ey};
        }
        function onDown(ev){
            if(claimed === TOTAL) return;
            if(mode === 'cpu' && turn === 2) { status("CPU's turn"); return; }
            if(cpuThinking) return;
            ev.preventDefault(); isDrag = true;
            let pos = getEventPos(ev); let hit = pickDot(pos.x, pos.y);
            if(!hit){ if(sel){ sel=null; status("Cancelled"); } return; }
            if(sel && isNeighbor(sel, hit)){ if(!makeMove(sel, hit)) status("Taken"); sel = null; isDrag = false; return; }
            if(sel && sel.r===hit.r && sel.c===hit.c){ sel=null; status("Cleared"); return; }
            sel = hit; status("Drag or Tap Neighbor");
        }
        function onMove(ev){
            if(mode === 'cpu' && turn === 2) return;
            if(!isDrag || !sel) return;
            ev.preventDefault(); let pos = getEventPos(ev); let hit = pickDot(pos.x, pos.y);
            if(hit && isNeighbor(sel, hit)){ if(!makeMove(sel, hit)) status("Taken"); sel = null; isDrag = false; }
        }
        function onUp(){ isDrag = false; }

        function spawnConfetti(){
            particles = [];
            const cc = document.getElementById('dots-confetti-canvas');
            let w = cc.width, h = cc.height;
            for(let i=0; i<150; i++){
                particles.push({ x: w/2, y: h/2, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20 - 5, c: Math.random()>0.5 ? C_P1 : C_P2, life: 1.0, size: Math.random()*10 + 5 });
            }
        }

        function draw(){
            if(currentGameId !== 'dots' || !canvas.width || !boxOwner) { requestAnimationFrame(draw); return; }
            let time = Date.now();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            if(particles.length){
                const cc = document.getElementById('dots-confetti-canvas'); const ctxC = cc.getContext('2d');
                ctxC.clearRect(0,0,cc.width,cc.height);
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.01;
                    ctxC.fillStyle = p.c; ctxC.globalAlpha = Math.max(0, p.life);
                    ctxC.fillRect(p.x, p.y, p.size, p.size);
                });
                particles = particles.filter(p => p.life > 0);
            }

            for(let r=0; r<BR; r++){
                for(let c=0; c<BC; c++){
                    let owner = boxOwner[r][c];
                    if(owner !== 0){
                        let prog = Math.min(1, (time - boxAnim[r][c]) / 300);
                        let scale = (prog < 1) ? prog * (1.5 - 0.5 * prog) : 1; 
                        let p = getXY(r,c);
                        ctx.fillStyle = (owner === 1) ? C_P1 : C_P2;
                        ctx.beginPath(); ctx.arc(p.x+STEP/2, p.y+STEP/2, (DOT_R * 2.5) * scale, 0, Math.PI*2); ctx.fill();
                        
                        if(highContrast) {
                            ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                            let cx = p.x+STEP/2, cy = p.y+STEP/2;
                            if(owner === 1) { 
                                ctx.beginPath(); ctx.moveTo(cx-5, cy-5); ctx.lineTo(cx+5, cy+5); ctx.moveTo(cx+5, cy-5); ctx.lineTo(cx-5, cy+5); ctx.stroke();
                            } else { 
                                ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.stroke();
                            }
                        }
                    }
                }
            }

            const gridCol = highContrast ? "#BBBBBB" : C_GRID;
            ctx.lineWidth = highContrast ? 3 : 2; ctx.strokeStyle = gridCol; ctx.lineCap = "round"; ctx.setLineDash([]); 
            ctx.beginPath();
            for(let r=0; r<DR; r++){ let h1=getXY(r,0), h2=getXY(r,DC-1); ctx.moveTo(h1.x, h1.y); ctx.lineTo(h2.x, h2.y); }
            for(let c=0; c<DC; c++){ let v1=getXY(0,c), v2=getXY(DR-1,c); ctx.moveTo(v1.x, v1.y); ctx.lineTo(v2.x, v2.y); }
            ctx.stroke();

            function drawLines(isVert){
                let R = isVert ? BR : DR; let C = isVert ? DC : BC;
                for(let r=0; r<R; r++){
                    for(let c=0; c<C; c++){
                        let p = isVert ? VO[r][c] : HO[r][c];
                        if(p !== 0){
                            let isLast = (lastMove && lastMove.type===(isVert?'V':'H') && lastMove.r===r && lastMove.c===c);
                            let start = getXY(r,c), end = isVert ? getXY(r+1,c) : getXY(r,c+1);
                            ctx.strokeStyle = (p===1) ? C_P1 : C_P2; ctx.lineWidth = highContrast ? (LINE_W * 1.15) : LINE_W; ctx.setLineDash([]);
                            if(highContrast){ ctx.shadowBlur = 8; ctx.shadowColor = "#000000"; } 
                            if(isLast) { ctx.shadowBlur = 10; ctx.shadowColor = "#fff"; } else { ctx.shadowBlur=0; }
                            
                            ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
                            ctx.shadowBlur=0; 
                            
                            if(isLast){
                                const baseCol = (p===1) ? C_P1 : C_P2;
                                const overlay = dashOverlayColor(baseCol);
                                ctx.strokeStyle = overlay; ctx.lineWidth = LINE_W * 0.8; let dash = Math.max(6, LINE_W * 0.8);
                                ctx.setLineDash([dash, dash]); ctx.lineDashOffset = -(time / 25) % (dash*2);
                                ctx.shadowBlur = highContrast ? 10 : 6;
                                ctx.shadowColor = (overlay === '#FFFFFF') ? '#000000' : '#FFFFFF';
                                ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
                                ctx.shadowBlur = 0;
                                ctx.setLineDash([]);
                            }
                        }
                    }
                }
            }
            drawLines(false); drawLines(true);

            for(let r=0; r<DR; r++){
                for(let c=0; c<DC; c++){
                    let p = getXY(r,c);
                    if(sel && sel.r===r && sel.c===c){ ctx.fillStyle = C_SEL; ctx.beginPath(); ctx.arc(p.x, p.y, DOT_R * 2.5, 0, Math.PI*2); ctx.fill(); }
                    ctx.fillStyle = C_DOT; ctx.beginPath(); ctx.arc(p.x, p.y, DOT_R, 0, Math.PI*2); ctx.fill();
                }
            }
            requestAnimationFrame(draw);
        }

        initColorPickerUI();
        syncMenuUI();

        canvas.addEventListener("pointerdown", onDown);
        canvas.addEventListener("pointermove", onMove);
        canvas.addEventListener("pointerup", onUp);
        canvas.addEventListener("pointerleave", onUp);
        document.getElementById('g-dots').querySelector('#undoBtn').addEventListener("click", undo);
        document.getElementById('g-dots').querySelector('#menuBtn').addEventListener("click", openNewGameMenu);
        document.getElementById('g-dots').querySelector('#playAgainBtn').addEventListener("click", openNewGameMenu);
        window.addEventListener("resize", fitCanvas);
        requestAnimationFrame(draw);

        syncMenuUI();
        return { startGame, resize: fitCanvas, resume: () => requestAnimationFrame(draw), toggleContrast, quit, setMode, setCpuLevel, syncGlobalContrast };
    })();

    

window.addEventListener('resize', () => {
        try{ if(window.__arcadeSelfResize) window.__arcadeSelfResize(); }catch(e){}
    });

try{ window.DotsGame = DotsGame; }catch(e){}
try{ window.FeedbackSys = FeedbackSys; }catch(e){}

function goToMenu() {
    try{ ArcadeSettings.closeModal(); }catch(e){}
    try{
        if(currentGameId === 'dots' && window.DotsGame && typeof DotsGame.quit === 'function') {
            DotsGame.quit();
        }
    }catch(e){}
    window.location.href = 'index.html';
}

try{
    currentGameId = 'dots';
    const view = document.getElementById('g-dots');
    if(view) view.classList.add('active');
}catch(e){}

try{
    setTimeout(() => DotsGame.resize(), 50); DotsGame.resume();
}catch(e){}

(function(){
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function installDrag(el, key){
    if(!el) return;
    const storeKey = 'arcade_drag_' + key;
    let dragging = false;
    let moved = false;
    let startX=0, startY=0, startL=0, startT=0;

    
    try{
      const raw = localStorage.getItem(storeKey);
      if(raw){
        const p = JSON.parse(raw);
        if(p && typeof p.left==='number' && typeof p.top==='number'){
          el.style.left = p.left + 'px';
          el.style.top  = p.top  + 'px';
          el.style.right = 'auto';
          el.style.bottom = 'auto';
          el.classList.add('drag-restored');
        }
      }
    }catch(e){}

    
    const cs = getComputedStyle(el);
    if(cs.position !== 'fixed') el.style.position = 'fixed';

    el.addEventListener('pointerdown', (e)=>{
      if(e.button !== undefined && e.button !== 0) return;
      dragging = true; moved = false;
      el.setPointerCapture?.(e.pointerId);
      const r = el.getBoundingClientRect();
      startX = e.clientX; startY = e.clientY;
      startL = r.left; startT = r.top;
      el.classList.add('dragging');
    });

    window.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if(!moved && (Math.abs(dx) + Math.abs(dy)) > 8) moved = true;
      if(!moved) return;
      e.preventDefault();
      const w = el.offsetWidth, h = el.offsetHeight;
      const maxL = window.innerWidth - w - 6;
      const maxT = window.innerHeight - h - 6;
      const L = clamp(startL + dx, 6, maxL);
      const T = clamp(startT + dy, 6, maxT);
      el.style.left = L + 'px';
      el.style.top  = T + 'px';
      el.style.right = 'auto';
      el.style.bottom = 'auto';
    }, {passive:false});

    window.addEventListener('pointerup', (e)=>{
      if(!dragging) return;
      dragging = false;
      el.classList.remove('dragging');
      if(moved){
        
        try{
          const r = el.getBoundingClientRect();
          localStorage.setItem(storeKey, JSON.stringify({left:r.left, top:r.top}));
        }catch(e){}
        
        const swallow = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); };
        el.addEventListener('click', swallow, {once:true, capture:true});
      }
    });
  }

  
  try{ installDrag(document.querySelector('.back-btn'), 'menu'); }catch(e){}
  try{ installDrag(document.getElementById('global-settings-btn'), 'settings'); }catch(e){}
})();

    
    (function(){
        function installDrag(el, key){
            if(!el) return;
            const storeKey = 'arcade_drag_' + key;
            let dragging = false;
            let pointerId = null;
            let sx=0, sy=0, startLeft=0, startTop=0;
            let moved = false;

            
            try{
                const raw = localStorage.getItem(storeKey);
                if(raw){
                    const p = JSON.parse(raw);
                    if(p && Number.isFinite(p.left) && Number.isFinite(p.top)){
                        el.style.left = p.left + 'px';
                        el.style.top  = p.top + 'px';
                        el.style.right = 'auto';
                    }
                }
            }catch(e){}

            function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

            el.addEventListener('pointerdown', (e) => {
                
                if(pointerId !== null) return;
                pointerId = e.pointerId;
                try{ el.setPointerCapture(pointerId); }catch(_e){}

                const r = el.getBoundingClientRect();
                sx = e.clientX; sy = e.clientY;
                startLeft = r.left; startTop = r.top;
                dragging = true;
                moved = false;
                el.classList.add('dragging');
            });

            window.addEventListener('pointermove', (e) => {
                if(!dragging || e.pointerId !== pointerId) return;
                const dx = e.clientX - sx;
                const dy = e.clientY - sy;
                if(!moved && (Math.abs(dx) + Math.abs(dy) > 8)) moved = true;
                if(!moved) return;

                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const r = el.getBoundingClientRect();
                const w = r.width;
                const h = r.height;

                let left = startLeft + dx;
                let top  = startTop + dy;
                left = clamp(left, 6, vw - w - 6);
                top  = clamp(top, 6, vh - h - 6);

                el.style.left = left + 'px';
                el.style.top  = top + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';

                try{
                    localStorage.setItem(storeKey, JSON.stringify({left, top}));
                }catch(_e){}

                e.preventDefault();
            }, { passive:false });

            function end(e){
                if(e && pointerId !== null && e.pointerId !== pointerId) return;
                if(!dragging) return;
                dragging = false;
                el.classList.remove('dragging');
                try{ if(pointerId !== null) el.releasePointerCapture(pointerId); }catch(_e){}
                pointerId = null;
            }

            window.addEventListener('pointerup', end);
            window.addEventListener('pointercancel', end);

            
            el.addEventListener('click', (e) => {
                if(moved){
                    e.preventDefault();
                    e.stopPropagation();
                    moved = false;
                }
            }, true);
        }

        installDrag(document.querySelector('.back-btn'), 'menu');
        installDrag(document.getElementById('global-settings-btn'), 'settings');
    })();

(function(){
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function installDrag(el, key){
    if(!el || el.__dragInstalled) return;
    el.__dragInstalled = true;
    el.style.touchAction = 'none';
    el.style.userSelect = 'none';
    el.style.webkitUserSelect = 'none';

    const storeKey = 'arcade_btnpos_' + key;
    try{
      const raw = localStorage.getItem(storeKey);
      if(raw){
        const p = JSON.parse(raw);
        if(p && Number.isFinite(p.x) && Number.isFinite(p.y)){
          el.style.left = p.x + 'px';
          el.style.top = p.y + 'px';
          el.style.right = 'auto';
          el.style.bottom = 'auto';
        }
      }
    }catch(e){}

    let dragging = false;
    let downX=0, downY=0, startLeft=0, startTop=0;

    function getLeft(){
      const r = el.getBoundingClientRect();
      return r.left;
    }
    function getTop(){
      const r = el.getBoundingClientRect();
      return r.top;
    }

    el.addEventListener('pointerdown', (ev)=>{
      if(ev.button != null && ev.button !== 0) return;
      dragging = false;
      downX = ev.clientX; downY = ev.clientY;
      startLeft = getLeft(); startTop = getTop();
      el.setPointerCapture(ev.pointerId);
    });

    el.addEventListener('pointermove', (ev)=>{
      if(!el.hasPointerCapture(ev.pointerId)) return;
      const dx = ev.clientX - downX;
      const dy = ev.clientY - downY;
      if(!dragging){
        if(Math.hypot(dx,dy) < 6) return;
        dragging = true;
        el.classList.add('dragging');
        
        el.style.left = startLeft + 'px';
        el.style.top = startTop + 'px';
        el.style.right = 'auto';
        el.style.bottom = 'auto';
      }
      ev.preventDefault();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const rect = el.getBoundingClientRect();
      const newLeft = clamp(startLeft + dx, 6, vw - rect.width - 6);
      const newTop  = clamp(startTop + dy, 6, vh - rect.height - 6);
      el.style.left = newLeft + 'px';
      el.style.top  = newTop + 'px';
    }, { passive:false });

    function finish(ev){
      if(!el.hasPointerCapture(ev.pointerId)) return;
      el.releasePointerCapture(ev.pointerId);
      if(dragging){
        ev.preventDefault();
        ev.stopPropagation();
        el.classList.remove('dragging');
        try{
          const r = el.getBoundingClientRect();
          localStorage.setItem(storeKey, JSON.stringify({x: Math.round(r.left), y: Math.round(r.top)}));
        }catch(e){}
      }
      dragging = false;
    }
    el.addEventListener('pointerup', finish);
    el.addEventListener('pointercancel', finish);

    
    el.addEventListener('click', (ev)=>{
      if(el.classList.contains('dragging')){ ev.preventDefault(); ev.stopPropagation(); }
    }, true);
  }

  try{ installDrag(document.querySelector('.back-btn'), 'menu'); }catch(e){}
  try{ installDrag(document.getElementById('global-settings-btn'), 'settings'); }catch(e){}
})();

</script>
</body>
</html>
